<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>IronTrack - Diário de Treino</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #e2e8f0; }
        
        /* Ocultar barra de rolagem mas permitir scroll */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Animações simples */
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Estilo para inputs numéricos */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        
        /* Safe area para iPhones */
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body class="h-screen w-full overflow-hidden flex flex-col items-center justify-center bg-slate-900">

    <!-- Container Principal -->
    <div class="w-full max-w-md h-full flex flex-col bg-slate-900 shadow-2xl relative overflow-hidden">
        
        <!-- Header -->
        <header class="bg-slate-800 p-4 shadow-md z-10 flex justify-between items-center border-b border-slate-700">
            <h1 class="text-xl font-bold text-blue-400 tracking-wide"><i class="fa-solid fa-dumbbell mr-2"></i>IronTrack</h1>
            <div id="header-actions">
                <!-- Botões dinâmicos aparecerão aqui -->
            </div>
        </header>

        <!-- Área de Conteúdo (Scrollável) -->
        <main id="app-content" class="flex-1 overflow-y-auto no-scrollbar p-4 pb-24 relative">
            <!-- O conteúdo das views será injetado aqui pelo JS -->
        </main>

        <!-- Barra de Navegação Inferior -->
        <nav class="bg-slate-800 border-t border-slate-700 p-2 safe-bottom z-20">
            <div class="flex justify-around items-center h-14">
                <button onclick="router.navigate('home')" aria-label="Ir para Treinos" class="nav-btn flex flex-col items-center text-slate-400 hover:text-blue-400 active:text-blue-500 transition w-full" data-target="home">
                    <i class="fa-solid fa-house text-xl mb-1"></i>
                    <span class="text-xs">Treinos</span>
                </button>
                <button onclick="router.navigate('history')" aria-label="Ir para Histórico" class="nav-btn flex flex-col items-center text-slate-400 hover:text-blue-400 active:text-blue-500 transition w-full" data-target="history">
                    <i class="fa-solid fa-calendar-check text-xl mb-1"></i>
                    <span class="text-xs">Histórico</span>
                </button>
                
                <!-- Botão de Treino Ativo (Dinâmico) -->
                <button id="nav-active-session" onclick="router.navigate('active-session')" aria-label="Ir para Treino Ativo" class="hidden nav-btn flex flex-col items-center text-blue-500 hover:text-blue-400 transition w-full animate-pulse" data-target="active-session">
                    <i class="fa-solid fa-heart-pulse text-xl mb-1"></i>
                    <span class="text-xs font-bold">Treinando</span>
                </button>

                <button onclick="router.navigate('exercises')" aria-label="Ir para Exercícios" class="nav-btn flex flex-col items-center text-slate-400 hover:text-blue-400 active:text-blue-500 transition w-full" data-target="exercises">
                    <i class="fa-solid fa-list-ul text-xl mb-1"></i>
                    <span class="text-xs">Exercícios</span>
                </button>
                <button onclick="router.navigate('settings')" aria-label="Ir para Configurações" class="nav-btn flex flex-col items-center text-slate-400 hover:text-blue-400 active:text-blue-500 transition w-full" data-target="settings">
                    <i class="fa-solid fa-gear text-xl mb-1"></i>
                    <span class="text-xs">Dados</span>
                </button>
            </div>
        </nav>

        <!-- Modais / Overlays -->
        <div id="modal-container" class="hidden absolute inset-0 bg-black/80 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
            <!-- Conteúdo do Modal Injetado aqui -->
        </div>

    </div>

    <!-- Scripts da Aplicação -->
    <script>
        // --- 1. BANCO DE DADOS DE EXERCÍCIOS ---
        const exerciseDB = [
            // --- PEITORAL ---
            { id: 'peito_01', name: 'Supino Reto (Barra)', category: 'Peitoral' },
            { id: 'peito_02', name: 'Supino Reto (Halteres)', category: 'Peitoral' },
            { id: 'peito_03', name: 'Supino Reto (Máquina)', category: 'Peitoral' },
            { id: 'peito_04', name: 'Supino Inclinado (Barra)', category: 'Peitoral' },
            { id: 'peito_05', name: 'Supino Inclinado (Halteres)', category: 'Peitoral' },
            { id: 'peito_06', name: 'Supino Inclinado (Máquina)', category: 'Peitoral' },
            { id: 'peito_07', name: 'Supino Declinado (Barra)', category: 'Peitoral' },
            { id: 'peito_08', name: 'Supino Declinado (Halteres)', category: 'Peitoral' },
            { id: 'peito_09', name: 'Crucifixo Reto (Halteres)', category: 'Peitoral' },
            { id: 'peito_10', name: 'Crucifixo Inclinado (Halteres)', category: 'Peitoral' },
            { id: 'peito_11', name: 'Peck Deck (Voador)', category: 'Peitoral' },
            { id: 'peito_12', name: 'Crossover Polia Alta', category: 'Peitoral' },
            { id: 'peito_13', name: 'Crossover Polia Média', category: 'Peitoral' },
            { id: 'peito_14', name: 'Crossover Polia Baixa', category: 'Peitoral' },
            { id: 'peito_15', name: 'Flexão de Braço (Solo)', category: 'Peitoral' },
            { id: 'peito_16', name: 'Flexão de Braço (Inclinada)', category: 'Peitoral' },
            { id: 'peito_17', name: 'Flexão de Braço (Declinada)', category: 'Peitoral' },
            { id: 'peito_18', name: 'Pullover (Halter)', category: 'Peitoral' },
            { id: 'peito_19', name: 'Supino Vertical (Sentado)', category: 'Peitoral' },
            
            // --- COSTAS ---
            { id: 'costas_01', name: 'Puxada Alta (Aberta)', category: 'Costas' },
            { id: 'costas_02', name: 'Puxada Alta (Fechada/Triângulo)', category: 'Costas' },
            { id: 'costas_03', name: 'Puxada Alta (Supinada)', category: 'Costas' },
            { id: 'costas_04', name: 'Remada Curvada (Barra)', category: 'Costas' },
            { id: 'costas_05', name: 'Remada Curvada (Halteres)', category: 'Costas' },
            { id: 'costas_06', name: 'Remada Unilateral (Serrote)', category: 'Costas' },
            { id: 'costas_07', name: 'Remada Baixa (Polia/Triângulo)', category: 'Costas' },
            { id: 'costas_08', name: 'Remada Máquina (Aberta)', category: 'Costas' },
            { id: 'costas_09', name: 'Remada Máquina (Fechada)', category: 'Costas' },
            { id: 'costas_10', name: 'Remada Cavalinho', category: 'Costas' },
            { id: 'costas_11', name: 'Barra Fixa (Pronada)', category: 'Costas' },
            { id: 'costas_12', name: 'Barra Fixa (Supinada)', category: 'Costas' },
            { id: 'costas_13', name: 'Barra Fixa (Neutra)', category: 'Costas' },
            { id: 'costas_14', name: 'Levantamento Terra', category: 'Costas' },
            { id: 'costas_15', name: 'Pulldown (Polia Alta)', category: 'Costas' },
            { id: 'costas_16', name: 'Extensão de Tronco (Banco Romano)', category: 'Costas' },
            { id: 'costas_17', name: 'Good Morning', category: 'Costas' },
            
            // --- PERNAS (Quadríceps, Posterior, Glúteo, Panturrilha) ---
            { id: 'pernas_01', name: 'Agachamento Livre (Barra)', category: 'Pernas' },
            { id: 'pernas_02', name: 'Agachamento Frontal', category: 'Pernas' },
            { id: 'pernas_03', name: 'Agachamento Smith', category: 'Pernas' },
            { id: 'pernas_04', name: 'Agachamento Sumô', category: 'Pernas' },
            { id: 'pernas_05', name: 'Agachamento Hack', category: 'Pernas' },
            { id: 'pernas_06', name: 'Agachamento Búlgaro', category: 'Pernas' },
            { id: 'pernas_07', name: 'Afundo (Passada)', category: 'Pernas' },
            { id: 'pernas_08', name: 'Leg Press 45', category: 'Pernas' },
            { id: 'pernas_09', name: 'Leg Press Horizontal', category: 'Pernas' },
            { id: 'pernas_10', name: 'Cadeira Extensora', category: 'Pernas' },
            { id: 'pernas_11', name: 'Mesa Flexora', category: 'Pernas' },
            { id: 'pernas_12', name: 'Cadeira Flexora', category: 'Pernas' },
            { id: 'pernas_13', name: 'Flexora em Pé', category: 'Pernas' },
            { id: 'pernas_14', name: 'Stiff (Barra)', category: 'Pernas' },
            { id: 'pernas_15', name: 'Stiff (Halteres)', category: 'Pernas' },
            { id: 'pernas_16', name: 'Levantamento Terra Romeno', category: 'Pernas' },
            { id: 'pernas_17', name: 'Elevação Pélvica (Barra)', category: 'Pernas' },
            { id: 'pernas_18', name: 'Elevação Pélvica (Máquina)', category: 'Pernas' },
            { id: 'pernas_19', name: 'Cadeira Abdutora', category: 'Pernas' },
            { id: 'pernas_20', name: 'Cadeira Adutora', category: 'Pernas' },
            { id: 'pernas_21', name: 'Glúteo Caneleira (4 Apoios)', category: 'Pernas' },
            { id: 'pernas_22', name: 'Glúteo Polia (Cabo)', category: 'Pernas' },
            { id: 'pernas_23', name: 'Panturrilha em Pé (Máquina)', category: 'Pernas' },
            { id: 'pernas_24', name: 'Panturrilha Sentado (Máquina)', category: 'Pernas' },
            { id: 'pernas_25', name: 'Panturrilha no Leg Press', category: 'Pernas' },
            { id: 'pernas_26', name: 'Panturrilha Unilateral (Halter)', category: 'Pernas' },

            // --- OMBROS (Deltoides e Trapézio) ---
            { id: 'ombros_01', name: 'Desenvolvimento Militar (Barra)', category: 'Ombros' },
            { id: 'ombros_02', name: 'Desenvolvimento (Halteres)', category: 'Ombros' },
            { id: 'ombros_03', name: 'Desenvolvimento Máquina', category: 'Ombros' },
            { id: 'ombros_04', name: 'Desenvolvimento Arnold', category: 'Ombros' },
            { id: 'ombros_05', name: 'Elevação Lateral (Halteres)', category: 'Ombros' },
            { id: 'ombros_06', name: 'Elevação Lateral (Polia)', category: 'Ombros' },
            { id: 'ombros_07', name: 'Elevação Frontal (Halteres)', category: 'Ombros' },
            { id: 'ombros_08', name: 'Elevação Frontal (Barra)', category: 'Ombros' },
            { id: 'ombros_09', name: 'Elevação Frontal (Polia)', category: 'Ombros' },
            { id: 'ombros_10', name: 'Crucifixo Inverso (Halteres)', category: 'Ombros' },
            { id: 'ombros_11', name: 'Crucifixo Inverso (Máquina)', category: 'Ombros' },
            { id: 'ombros_12', name: 'Face Pull (Polia)', category: 'Ombros' },
            { id: 'ombros_13', name: 'Remada Alta (Barra)', category: 'Ombros' },
            { id: 'ombros_14', name: 'Encolhimento (Halteres)', category: 'Ombros' },
            { id: 'ombros_15', name: 'Encolhimento (Barra)', category: 'Ombros' },

            // --- BÍCEPS ---
            { id: 'biceps_01', name: 'Rosca Direta (Barra Reta)', category: 'Bíceps' },
            { id: 'biceps_02', name: 'Rosca Direta (Barra W)', category: 'Bíceps' },
            { id: 'biceps_03', name: 'Rosca Direta (Halteres)', category: 'Bíceps' },
            { id: 'biceps_04', name: 'Rosca Direta (Polia)', category: 'Bíceps' },
            { id: 'biceps_05', name: 'Rosca Alternada', category: 'Bíceps' },
            { id: 'biceps_06', name: 'Rosca Martelo (Halteres)', category: 'Bíceps' },
            { id: 'biceps_07', name: 'Rosca Martelo (Corda)', category: 'Bíceps' },
            { id: 'biceps_08', name: 'Rosca Scott (Barra W)', category: 'Bíceps' },
            { id: 'biceps_09', name: 'Rosca Scott (Máquina)', category: 'Bíceps' },
            { id: 'biceps_10', name: 'Rosca Concentrada', category: 'Bíceps' },
            { id: 'biceps_11', name: 'Rosca Inclinada (Banco 45)', category: 'Bíceps' },
            { id: 'biceps_12', name: 'Rosca 21', category: 'Bíceps' },

            // --- TRÍCEPS ---
            { id: 'triceps_01', name: 'Tríceps Polia (Barra Reta)', category: 'Tríceps' },
            { id: 'triceps_02', name: 'Tríceps Polia (Barra V)', category: 'Tríceps' },
            { id: 'triceps_03', name: 'Tríceps Corda', category: 'Tríceps' },
            { id: 'triceps_04', name: 'Tríceps Testa (Barra W)', category: 'Tríceps' },
            { id: 'triceps_05', name: 'Tríceps Testa (Halteres)', category: 'Tríceps' },
            { id: 'triceps_06', name: 'Tríceps Francês (Halter)', category: 'Tríceps' },
            { id: 'triceps_07', name: 'Tríceps Francês (Corda)', category: 'Tríceps' },
            { id: 'triceps_08', name: 'Tríceps Coice (Halter)', category: 'Tríceps' },
            { id: 'triceps_09', name: 'Tríceps Coice (Polia)', category: 'Tríceps' },
            { id: 'triceps_10', name: 'Mergulho (Paralelas)', category: 'Tríceps' },
            { id: 'triceps_11', name: 'Mergulho (Banco)', category: 'Tríceps' },
            { id: 'triceps_12', name: 'Supino Fechado', category: 'Tríceps' },

            // --- ABDÔMEN ---
            { id: 'abs_01', name: 'Abdominal Supra (Solo)', category: 'Abdômen' },
            { id: 'abs_02', name: 'Abdominal Infra (Solo)', category: 'Abdômen' },
            { id: 'abs_03', name: 'Abdominal Remador', category: 'Abdômen' },
            { id: 'abs_04', name: 'Abdominal Bicicleta', category: 'Abdômen' },
            { id: 'abs_05', name: 'Prancha Isométrica', category: 'Abdômen' },
            { id: 'abs_06', name: 'Prancha Lateral', category: 'Abdômen' },
            { id: 'abs_07', name: 'Elevação de Pernas (Barra)', category: 'Abdômen' },
            { id: 'abs_08', name: 'Abdominal na Polia (Crunch)', category: 'Abdômen' },
            { id: 'abs_09', name: 'Abdominal Máquina', category: 'Abdômen' },
            { id: 'abs_10', name: 'Russian Twist', category: 'Abdômen' },
            { id: 'abs_11', name: 'V-Up', category: 'Abdômen' },
            { id: 'abs_12', name: 'Roda Abdominal', category: 'Abdômen' },

            // --- CARDIO ---
            { id: 'cardio_01', name: 'Esteira (Caminhada)', category: 'Cardio' },
            { id: 'cardio_02', name: 'Esteira (Corrida)', category: 'Cardio' },
            { id: 'cardio_03', name: 'Esteira (Inclinada)', category: 'Cardio' },
            { id: 'cardio_04', name: 'Bicicleta Ergométrica', category: 'Cardio' },
            { id: 'cardio_05', name: 'Bicicleta Spinning', category: 'Cardio' },
            { id: 'cardio_06', name: 'Elíptico (Transport)', category: 'Cardio' },
            { id: 'cardio_07', name: 'Escada (Simulador)', category: 'Cardio' },
            { id: 'cardio_08', name: 'Remo (Ergômetro)', category: 'Cardio' },
            { id: 'cardio_09', name: 'Pular Corda', category: 'Cardio' },
            { id: 'cardio_10', name: 'Polichinelos', category: 'Cardio' },
            { id: 'cardio_11', name: 'Burpees', category: 'Cardio' },
            { id: 'cardio_12', name: 'Box Jump', category: 'Cardio' },

            // --- ALONGAMENTO / MOBILIDADE ---
            { id: 'along_01', name: 'Alongamento Geral', category: 'Alongamento' },
            { id: 'along_02', name: 'Mobilidade de Ombro', category: 'Alongamento' },
            { id: 'along_03', name: 'Mobilidade de Quadril', category: 'Alongamento' },
            { id: 'along_04', name: 'Mobilidade de Tornozelo', category: 'Alongamento' },
            { id: 'along_05', name: 'Liberação Miofascial', category: 'Alongamento' }
        ];

        // --- 2. GESTÃO DE ESTADO E DADOS ---
        const store = {
            data: {
                plans: [], // { id, name, exercises: [] }
                logs: [],  // { id, date, planName, details: [] }
                version: 1.0
            },
            
            // Gerenciador de Sessão Ativa Global
            activeSession: {
                current: null, // { planId, startTime, exercises: [], ... }
                timerId: null,
                
                saveSession() {
                    if (this.current) {
                        localStorage.setItem('ironTrackActiveSession', JSON.stringify(this.current));
                    } else {
                        localStorage.removeItem('ironTrackActiveSession');
                    }
                },

                loadSession() {
                    const saved = localStorage.getItem('ironTrackActiveSession');
                    if (saved) {
                        try {
                            this.current = JSON.parse(saved);
                            // Se carregou uma sessão, verifica se o timer deve continuar
                            if (this.current && this.current.startTime) {
                                this.startTimer();
                                this.updateNavVisibility(true);
                            }
                        } catch (e) {
                            console.error("Erro ao carregar sessão ativa", e);
                            this.current = null;
                        }
                    }
                },

                start(plan, initialExercises) {
                    if (this.current) return; // Já existe sessão ativa
                    this.current = {
                        planId: plan.id,
                        planName: plan.name,
                        startTime: Date.now(),
                        exercises: initialExercises
                    };
                    this.saveSession(); // Persiste inicio
                    this.startTimer();
                    this.updateNavVisibility(true);
                },

                startTimer() {
                    if (this.timerId) clearInterval(this.timerId);
                    this.timerId = setInterval(() => {
                        const timerEl = document.getElementById('session-timer');
                        if (timerEl && this.current) {
                            const diff = Math.floor((Date.now() - this.current.startTime) / 1000);
                            const m = Math.floor(diff / 60).toString().padStart(2, '0');
                            const s = (diff % 60).toString().padStart(2, '0');
                            timerEl.innerText = `${m}:${s}`;
                        }
                    }, 1000);
                },

                end() {
                    this.current = null;
                    this.saveSession(); // Persiste fim (remove)
                    if (this.timerId) {
                        clearInterval(this.timerId);
                        this.timerId = null;
                    }
                    this.updateNavVisibility(false);
                },

                updateNavVisibility(isVisible) {
                    const btn = document.getElementById('nav-active-session');
                    if (btn) {
                        if(isVisible) {
                            btn.classList.remove('hidden');
                        } else {
                            btn.classList.add('hidden');
                        }
                    }
                }
            },
            
            init() {
                const saved = localStorage.getItem('ironTrackData');
                if (saved) {
                    try {
                        this.data = JSON.parse(saved);
                    } catch (e) {
                        console.error("Erro ao carregar dados", e);
                    }
                } else {
                    // Dados iniciais de exemplo
                    this.createPlan("Treino A - Peito e Tríceps", ['peito_01', 'peito_02', 'triceps_01']);
                    this.createPlan("Treino B - Costas e Bíceps", ['costas_01', 'costas_02', 'biceps_01']);
                }
                
                // Recuperar sessão ativa do localStorage
                this.activeSession.loadSession();
            },

            save() {
                localStorage.setItem('ironTrackData', JSON.stringify(this.data));
            },

            createPlan(name, exerciseIds) {
                const newPlan = {
                    id: Date.now().toString(),
                    name: name,
                    exercises: exerciseIds.map(id => ({ id: id, sets: 3, targetReps: 10 }))
                };
                this.data.plans.push(newPlan);
                this.save();
            },

            updatePlan(id, name, exerciseIds) {
                const planIndex = this.data.plans.findIndex(p => p.id === id);
                if (planIndex !== -1) {
                    this.data.plans[planIndex].name = name;
                    this.data.plans[planIndex].exercises = exerciseIds.map(id => ({ id: id, sets: 3, targetReps: 10 }));
                    this.save();
                }
            },

            deletePlan(id) {
                this.data.plans = this.data.plans.filter(p => p.id !== id);
                this.save();
                
                // Se o plano deletado for o ativo, encerra a sessão
                if (this.activeSession.current && this.activeSession.current.planId === id) {
                    this.activeSession.end();
                }
            },

            saveLog(log) {
                this.data.logs.unshift(log); // Adiciona no início
                this.save();
            },

            exportData(type = 'all', specificIds = null) {
                let dataToExport = {};
                let fileNamePrefix = 'irontrack_backup_';

                if (type === 'history') {
                    dataToExport = { logs: this.data.logs, version: this.data.version };
                    fileNamePrefix = 'irontrack_history_';
                } else if (type === 'plans') {
                    let plansToExport = this.data.plans;
                    if (specificIds && Array.isArray(specificIds)) {
                        plansToExport = plansToExport.filter(p => specificIds.includes(p.id));
                    }
                    dataToExport = { plans: plansToExport, version: this.data.version };
                    fileNamePrefix = 'irontrack_plans_';
                } else {
                    dataToExport = this.data;
                }

                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(dataToExport));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", fileNamePrefix + new Date().toISOString().slice(0,10) + ".json");
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
            },

            importData(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const imported = JSON.parse(e.target.result);
                        let msg = '';

                        // Lógica de Merge Inteligente
                        if (imported.plans && !imported.logs) {
                            // Importando apenas Planos
                            this.data.plans = imported.plans;
                            msg = 'Planos importados com sucesso! Seu histórico foi mantido.';
                        } else if (imported.logs && !imported.plans) {
                            // Importando apenas Histórico
                            this.data.logs = imported.logs;
                            msg = 'Histórico importado com sucesso! Seus planos foram mantidos.';
                        } else if (imported.plans && imported.logs) {
                            // Importando Completo
                            this.data = imported;
                            msg = 'Backup completo restaurado com sucesso!';
                        } else {
                            throw new Error('Formato inválido');
                        }

                        this.save();
                        ui.showToast(msg);
                        router.navigate('home');
                        
                    } catch (ex) {
                        ui.showToast('Erro: Arquivo inválido ou corrompido.', 'error');
                        console.error(ex);
                    }
                };
                reader.readAsText(file);
            }
        };

        // --- UI HELPERS (Substituindo alerts/confirms nativos) ---
        const ui = {
            toastTimeout: null,

            showModal({ title, message, type = 'info', onConfirm, onCancel, confirmText = 'Confirmar', cancelText = 'Cancelar' }) {
                const container = document.getElementById('modal-container');
                container.classList.remove('hidden');
                
                let icon = '';
                let btnClass = 'bg-blue-600 hover:bg-blue-500 shadow-blue-900/20';

                if (type === 'danger') {
                    icon = '<div class="mx-auto flex h-16 w-16 flex-shrink-0 items-center justify-center rounded-full bg-red-900/30 sm:mx-0 sm:h-12 sm:w-12 mb-5 ring-1 ring-red-500/50"><i class="fa-solid fa-triangle-exclamation text-red-500 text-2xl"></i></div>';
                    btnClass = 'bg-red-600 hover:bg-red-500 shadow-red-900/20';
                } else if (type === 'success') {
                    icon = '<div class="mx-auto flex h-16 w-16 flex-shrink-0 items-center justify-center rounded-full bg-emerald-900/30 sm:mx-0 sm:h-12 sm:w-12 mb-5 ring-1 ring-emerald-500/50"><i class="fa-solid fa-check text-emerald-500 text-2xl"></i></div>';
                    btnClass = 'bg-emerald-600 hover:bg-emerald-500 shadow-emerald-900/20';
                } else {
                     icon = '<div class="mx-auto flex h-16 w-16 flex-shrink-0 items-center justify-center rounded-full bg-blue-900/30 sm:mx-0 sm:h-12 sm:w-12 mb-5 ring-1 ring-blue-500/50"><i class="fa-solid fa-info text-blue-500 text-2xl"></i></div>';
                }

                const isConfirm = !!onConfirm;

                container.innerHTML = `
                    <div class="relative transform overflow-hidden rounded-2xl bg-slate-800 text-left shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-lg border border-slate-700 w-full max-w-xs mx-auto fade-in ring-1 ring-white/10">
                        <div class="bg-slate-800 px-6 pb-6 pt-8">
                            <div class="flex flex-col items-center text-center">
                                ${icon}
                                <div class="mt-2 text-center w-full">
                                    <h3 class="text-xl font-bold leading-6 text-white mb-2" id="modal-title">${title}</h3>
                                    <div class="mt-2">
                                        <p class="text-base text-slate-400 leading-relaxed">${message}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="bg-slate-900/50 px-6 py-4 flex flex-col sm:flex-row-reverse gap-3">
                            ${isConfirm ? `
                                <button type="button" id="modal-confirm-btn" class="inline-flex w-full justify-center rounded-xl ${btnClass} px-4 py-3 text-base font-bold text-white shadow-lg sm:ml-3 sm:w-auto transition transform active:scale-[0.98]">
                                    ${confirmText}
                                </button>
                                <button type="button" id="modal-cancel-btn" class="inline-flex w-full justify-center rounded-xl bg-slate-800 px-4 py-3 text-base font-semibold text-slate-300 shadow-sm ring-1 ring-inset ring-slate-600 hover:bg-slate-700 sm:mt-0 sm:w-auto transition active:scale-[0.98]">
                                    ${cancelText}
                                </button>
                            ` : `
                                <button type="button" id="modal-ok-btn" class="inline-flex w-full justify-center rounded-xl bg-blue-600 px-4 py-3 text-base font-bold text-white shadow-lg hover:bg-blue-500 sm:ml-3 sm:w-auto transition transform active:scale-[0.98]">
                                    Entendi
                                </button>
                            `}
                        </div>
                    </div>
                `;

                const close = () => {
                    container.classList.add('hidden');
                    container.innerHTML = '';
                };

                if (isConfirm) {
                    document.getElementById('modal-confirm-btn').onclick = () => { close(); onConfirm(); };
                    document.getElementById('modal-cancel-btn').onclick = () => { close(); if(onCancel) onCancel(); };
                } else {
                    document.getElementById('modal-ok-btn').onclick = () => { close(); if(onConfirm) onConfirm(); };
                }
            },

            showToast(message, type = 'success') {
                let toastContainer = document.getElementById('toast-container');
                if (!toastContainer) {
                    toastContainer = document.createElement('div');
                    toastContainer.id = 'toast-container';
                    toastContainer.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 z-[60] flex flex-col gap-2 w-max max-w-xs';
                    document.body.appendChild(toastContainer);
                }

                const toast = document.createElement('div');
                const bgClass = type === 'success' ? 'bg-emerald-600' : (type === 'error' ? 'bg-red-600' : 'bg-blue-600');
                
                toast.className = `${bgClass} text-white px-4 py-3 rounded-lg shadow-lg flex items-center gap-3 text-sm font-medium fade-in shadow-black/30`;
                toast.innerHTML = `
                    <i class="fa-solid ${type === 'success' ? 'fa-check-circle' : (type === 'error' ? 'fa-circle-exclamation' : 'fa-info-circle')}"></i>
                    <span>${message}</span>
                `;

                toastContainer.appendChild(toast);

                setTimeout(() => {
                    toast.style.opacity = '0';
                    toast.style.transform = 'translateY(-10px)';
                    toast.style.transition = 'all 0.3s';
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            },

            showPlanSelectionModal() {
                const container = document.getElementById('modal-container');
                container.classList.remove('hidden');

                const plans = store.data.plans;
                if (plans.length === 0) {
                    ui.showToast('Nenhum plano para exportar.', 'info');
                    container.classList.add('hidden');
                    return;
                }

                const plansHtml = plans.map(p => `
                    <label class="flex items-center space-x-3 p-3 rounded-lg hover:bg-slate-700/50 cursor-pointer border border-slate-700 transition">
                        <input type="checkbox" value="${p.id}" checked class="form-checkbox h-5 w-5 text-blue-600 rounded bg-slate-700 border-slate-500 focus:ring-blue-500 focus:ring-offset-slate-800">
                        <span class="text-white font-medium">${p.name}</span>
                    </label>
                `).join('');

                container.innerHTML = `
                    <div class="relative transform overflow-hidden rounded-2xl bg-slate-800 text-left shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-lg border border-slate-700 w-full max-w-sm mx-auto fade-in ring-1 ring-white/10">
                        <div class="bg-slate-800 px-6 pb-6 pt-6">
                            <h3 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                                <i class="fa-solid fa-clipboard-check text-blue-500"></i> Selecionar Planos
                            </h3>
                            <div class="max-h-60 overflow-y-auto space-y-2 pr-1 custom-scrollbar">
                                ${plansHtml}
                            </div>
                        </div>
                        <div class="bg-slate-900/50 px-6 py-4 flex flex-col sm:flex-row-reverse gap-3">
                            <button id="modal-export-confirm-btn" class="inline-flex w-full justify-center rounded-xl bg-blue-600 px-4 py-3 text-base font-bold text-white shadow-lg hover:bg-blue-500 sm:ml-3 sm:w-auto transition transform active:scale-[0.98]">
                                Exportar Selecionados
                            </button>
                            <button onclick="document.getElementById('modal-container').classList.add('hidden')" class="inline-flex w-full justify-center rounded-xl bg-slate-800 px-4 py-3 text-base font-semibold text-slate-300 shadow-sm ring-1 ring-inset ring-slate-600 hover:bg-slate-700 sm:mt-0 sm:w-auto transition active:scale-[0.98]">
                                Cancelar
                            </button>
                        </div>
                    </div>
                `;

                document.getElementById('modal-export-confirm-btn').onclick = () => {
                    const checkboxes = container.querySelectorAll('input[type="checkbox"]:checked');
                    const selectedIds = Array.from(checkboxes).map(cb => cb.value);
                    
                    if (selectedIds.length === 0) {
                        ui.showToast('Selecione pelo menos um plano.', 'error');
                        return;
                    }

                    store.exportData('plans', selectedIds);
                    container.classList.add('hidden');
                    ui.showToast(`${selectedIds.length} plano(s) exportado(s).`);
                };
            },
        };

        // --- 3. ROTEAMENTO E VIEWS ---
        const router = {
            currentView: 'home',
            
            navigate(view, params = null) {
                this.currentView = view;
                
                // Atualiza abas
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    // Remove state ativo de todos
                    btn.classList.remove('text-blue-400', 'text-blue-500'); 
                    btn.classList.add('text-slate-400');
                    
                    // Caso especial: Botão de Treino Ativo sempre tem destaque se visível, mas mudamos a cor se for a view atual
                    if (btn.id === 'nav-active-session') {
                         btn.classList.remove('text-slate-400'); // Ele já é colorido por padrão, mas ok reforçar
                         if (view === 'active-session') {
                             btn.classList.add('text-blue-400'); // Ativo na view
                         } else {
                             btn.classList.add('text-blue-500'); // Ativo em background
                         }
                    } else if (btn.dataset.target === view) {
                        btn.classList.add('text-blue-400');
                        btn.classList.remove('text-slate-400');
                    }
                });

                const content = document.getElementById('app-content');
                const actions = document.getElementById('header-actions');
                
                content.innerHTML = '';
                actions.innerHTML = '';

                switch(view) {
                    case 'home':
                        this.renderHome(content, actions);
                        break;
                    case 'create-plan':
                        this.renderCreatePlan(content, actions);
                        break;
                    case 'active-session':
                        this.renderActiveSession(content, actions, params);
                        break;
                    case 'history':
                        this.renderHistory(content);
                        break;
                    case 'exercises':
                        this.renderExercises(content);
                        break;
                    case 'settings':
                        this.renderSettings(content);
                        break;
                }
            },

            // --- VIEW: HOME (Listagem de Planos) ---
            renderHome(container, headerActions) {
                headerActions.innerHTML = `
                    <button onclick="router.navigate('create-plan')" class="bg-blue-600 hover:bg-blue-500 text-white px-3 py-1 rounded font-bold text-sm transition">
                        <i class="fa-solid fa-plus mr-1"></i> Novo Treino
                    </button>
                `;

                if (store.data.plans.length === 0) {
                    container.innerHTML = `
                        <div class="flex flex-col items-center justify-center h-full text-slate-500 fade-in">
                            <i class="fa-solid fa-clipboard-list text-6xl mb-4"></i>
                            <p>Nenhum plano de treino.</p>
                            <p class="text-sm">Crie um novo para começar!</p>
                        </div>
                    `;
                    return;
                }

                let html = `<div class="space-y-4 fade-in">`;
                store.data.plans.forEach(plan => {
                    const exerciseCount = plan.exercises.length;
                    const exerciseNames = plan.exercises.slice(0, 3).map(e => {
                        const exDef = exerciseDB.find(db => db.id === e.id);
                        return exDef ? exDef.name : 'Exer';
                    }).join(', ') + (exerciseCount > 3 ? '...' : '');

                    html += `
                        <div class="bg-slate-800 rounded-xl p-4 shadow-lg border border-slate-700 relative group">
                            <div class="flex justify-between items-start mb-2">
                                <h3 class="text-lg font-bold text-white">${plan.name}</h3>
                                <div class="flex gap-2">
                                    <button onclick="router.navigate('create-plan', '${plan.id}')" aria-label="Editar plano" class="text-blue-400 hover:text-blue-300 p-2 rounded-full hover:bg-blue-900/30 transition">
                                        <i class="fa-solid fa-pen"></i>
                                    </button>
                                    <button onclick="ui.showModal({ title: 'Excluir Plano', message: 'Tem certeza que deseja excluir este plano?', type: 'danger', confirmText: 'Excluir', onConfirm: () => { store.deletePlan('${plan.id}'); router.navigate('home'); ui.showToast('Plano excluído'); } })" aria-label="Excluir plano" class="text-red-400 hover:text-red-300 p-2 rounded-full hover:bg-red-900/30 transition">
                                        <i class="fa-solid fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <p class="text-slate-400 text-sm mb-4 h-10 overflow-hidden text-ellipsis">${exerciseNames}</p>
                            <button onclick="router.navigate('active-session', '${plan.id}')" class="w-full bg-blue-600 hover:bg-blue-500 active:scale-95 text-white font-bold py-3 rounded-lg transition flex items-center justify-center">
                                <i class="fa-solid fa-play mr-2"></i> INICIAR TREINO
                            </button>
                        </div>
                    `;
                });
                html += `</div>`;
                container.innerHTML = html;
            },

            // --- VIEW: CRIAR/EDITAR PLANO ---
            renderCreatePlan(container, headerActions, planId = null) {
                headerActions.innerHTML = `
                    <button onclick="router.navigate('home')" class="text-slate-400 hover:text-white text-sm">Cancelar</button>
                `;

                let selectedExercises = [];
                let planToEdit = null;
                
                if (planId) {
                    planToEdit = store.data.plans.find(p => p.id === planId);
                    if (planToEdit) {
                        selectedExercises = planToEdit.exercises.map(e => e.id);
                    }
                }

                container.innerHTML = `
                    <div class="fade-in space-y-4">
                        <h2 class="text-xl font-bold text-white mb-2">${planToEdit ? 'Editar Treino' : 'Novo Treino'}</h2>
                        <div>
                            <label class="block text-sm font-medium text-slate-400 mb-1">Nome do Treino</label>
                            <input type="text" id="plan-name" value="${planToEdit ? planToEdit.name : ''}" placeholder="Ex: Costas e Bíceps" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-white focus:border-blue-500 focus:outline-none transition">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-slate-400 mb-1">Selecionar Exercícios</label>
                            <input type="text" id="search-ex" aria-label="Buscar exercício para adicionar" placeholder="Buscar exercício..." class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-white mb-2 text-sm focus:border-blue-500 outline-none transition">
                            
                            <div id="exercise-list" class="h-64 overflow-y-auto bg-slate-800 rounded-lg border border-slate-700 p-2 space-y-1">
                                <!-- Lista populada via JS -->
                            </div>
                        </div>

                        <div id="selected-list" class="bg-slate-800/50 p-3 rounded-lg min-h-[50px] border border-dashed border-slate-600">
                            <p class="text-xs text-slate-500 text-center italic">Nenhum exercício selecionado</p>
                        </div>

                        <button id="save-plan-btn" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg mt-4 opacity-50 cursor-not-allowed" disabled>
                            ${planToEdit ? 'ATUALIZAR PLANO' : 'SALVAR PLANO'}
                        </button>
                    </div>
                `;

                // Logica do Search
                const listEl = document.getElementById('exercise-list');
                const searchInput = document.getElementById('search-ex');
                const selectedEl = document.getElementById('selected-list');
                const saveBtn = document.getElementById('save-plan-btn');

                const renderList = (filter = '') => {
                    listEl.innerHTML = '';
                    const filtered = exerciseDB.filter(e => e.name.toLowerCase().includes(filter.toLowerCase()) || e.category.toLowerCase().includes(filter.toLowerCase()));
                    
                    filtered.forEach(ex => {
                        const isSelected = selectedExercises.includes(ex.id);
                        const item = document.createElement('div');
                        item.className = `p-2 rounded cursor-pointer flex justify-between items-center ${isSelected ? 'bg-blue-900/30 text-blue-400' : 'hover:bg-slate-700 text-slate-300'}`;
                        item.innerHTML = `<span>${ex.name} <small class="text-slate-500 ml-2">(${ex.category})</small></span> ${isSelected ? '<i class="fa-solid fa-check"></i>' : ''}`;
                        item.onclick = () => toggleSelect(ex.id);
                        listEl.appendChild(item);
                    });
                };

                const toggleSelect = (id) => {
                    if (selectedExercises.includes(id)) {
                        selectedExercises = selectedExercises.filter(e => e !== id);
                    } else {
                        selectedExercises.push(id);
                    }
                    renderList(searchInput.value);
                    updateSelectedView();
                };

                const updateSelectedView = () => {
                    if (selectedExercises.length === 0) {
                        selectedEl.innerHTML = '<p class="text-xs text-slate-500 text-center italic">Nenhum exercício selecionado</p>';
                        saveBtn.disabled = true;
                        saveBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    } else {
                        selectedEl.innerHTML = selectedExercises.map(id => {
                            const ex = exerciseDB.find(e => e.id === id);
                            return `<span class="inline-block bg-slate-700 text-xs px-2 py-1 rounded mr-1 mb-1 border border-slate-600">${ex.name}</span>`;
                        }).join('');
                        saveBtn.disabled = false;
                        saveBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                        saveBtn.classList.add('hover:bg-blue-500');
                    }
                };

                searchInput.addEventListener('input', (e) => renderList(e.target.value));
                
                saveBtn.addEventListener('click', () => {
                    const name = document.getElementById('plan-name').value || 'Treino Sem Nome';
                    if (planId) {
                        store.updatePlan(planId, name, selectedExercises);
                        ui.showToast('Plano atualizado com sucesso!');
                    } else {
                        store.createPlan(name, selectedExercises);
                        ui.showToast('Plano criado com sucesso!');
                    }
                    router.navigate('home');
                });

                renderList();
                updateSelectedView();
            },

            // --- VIEW: SESSÃO ATIVA (TREINO) ---
            renderActiveSession(container, headerActions, planId) {
                // Se não passou ID, tenta recuperar da sessão ativa
                if (!planId && store.activeSession.current) {
                    planId = store.activeSession.current.planId;
                }

                const plan = store.data.plans.find(p => p.id === planId);
                
                // Se não achou plano nem na URL nem na sessão ativa, volta pra home
                if (!plan) return router.navigate('home');

                // Busca último log para histórico/PR (Disponível para todo o escopo)
                const lastLog = store.data.logs.find(l => l.workoutId === plan.id || l.planName === plan.name);

                // Lógica de Inicialização Global
                if (!store.activeSession.current || store.activeSession.current.planId !== planId) {
                    if (store.activeSession.current && store.activeSession.current.planId !== planId) {
                        ui.showModal({
                            title: 'Treino em Andamento',
                            message: 'Já existe um treino em andamento. Deseja cancelar o atual e iniciar este?',
                            type: 'info',
                            onConfirm: () => {
                                store.activeSession.end();
                                initSession();
                            },
                            onCancel: () => router.navigate('home')
                        });
                        return; // Para execução até confirmar
                    } else {
                        initSession();
                    }
                } else {
                    renderSession();
                }

                function initSession() {
                    const initialExercises = plan.exercises.map(ex => {
                        let sets = [];
                        
                        // Busca o último registro válido para este exercício em TODO o histórico
                        // Ordena logs por data (do mais recente para o mais antigo) - já deve estar assim por padrão no store.data.logs.unshift
                        // Mas para garantir:
                        const sortedLogs = [...store.data.logs].sort((a, b) => new Date(b.date) - new Date(a.date));
                        
                        let lastValidSets = null;

                        for (const log of sortedLogs) {
                            const details = log.details.find(d => d.exerciseId === ex.id);
                            // Verifica se existe o detalhe e se tem sets com dados válidos (pelo menos peso ou repetições preenchidos)
                            if (details && details.sets && details.sets.length > 0) {
                                // Verifica se tem pelo menos um set com dados
                                const hasData = details.sets.some(s => (s.weight !== '' && s.weight != null) || (s.reps !== '' && s.reps != null));
                                if (hasData) {
                                    lastValidSets = details.sets;
                                    break; // Encontrou, para de procurar
                                }
                            }
                        }

                        if (lastValidSets) {
                            sets = lastValidSets.map(s => ({
                                weight: s.weight,
                                reps: s.reps,
                                done: false 
                            }));
                        }
                        
                        if (sets.length === 0) sets.push({ weight: '', reps: '', done: false });
                        
                        return {
                            id: ex.id,
                            activeSetIndex: 0, 
                            skipped: false,    
                            sets: sets
                        };
                    });

                    store.activeSession.start(plan, initialExercises);
                    renderSession();
                }

                function renderSession() {
                    // Recupera a sessão (seja recém criada ou existente)
                    const sessionData = store.activeSession.current;

                    // Reinicia o timer visual
                    store.activeSession.startTimer(); 

                    headerActions.innerHTML = `<div id="session-timer" aria-label="Tempo de treino" class="font-mono text-xl text-blue-400 font-bold">00:00</div>`;

                    const renderInitialSession = () => {
                        let html = `<div class="pb-10 fade-in space-y-8">`;
                        
                        html += `<h2 class="text-2xl font-bold text-white mb-4 border-b border-slate-700 pb-4">${plan.name}</h2>`;

                        sessionData.exercises.forEach((sessionEx, exIndex) => {
                            const exDef = exerciseDB.find(db => db.id === sessionEx.id);
                            const isSkipped = sessionEx.skipped;
                            
                            // Encontra maior carga histórica para referência (PR)
                            let maxWeight = '-';
                            // Varre todos logs para achar PR
                            store.data.logs.forEach(l => {
                                const d = l.details.find(det => det.exerciseId === sessionEx.id);
                                if(d && d.sets) {
                                    d.sets.forEach(s => {
                                        const w = Number(s.weight);
                                        if(!isNaN(w) && (maxWeight === '-' || w > parseFloat(maxWeight))) {
                                            maxWeight = w + 'kg';
                                        }
                                    });
                                }
                            });

                            html += `
                                <div id="exercise-block-${exIndex}" class="space-y-3 transition-all duration-300 ${isSkipped ? 'opacity-50 grayscale' : ''}">
                                    <div class="flex justify-between items-center px-1">
                                        <div class="flex flex-col">
                                                                                    <h3 class="font-bold text-xl text-blue-400 flex items-center gap-2">
                                                                                        ${exDef.name}
                                                                                        ${isSkipped ? '<span class="skipped-badge ml-2 px-3 py-1 bg-slate-700/80 text-slate-300 text-[10px] font-bold uppercase tracking-wider rounded-full border border-slate-600 shadow-sm backdrop-blur-sm">Pulado</span>' : ''}
                                                                                    </h3>                                            <span class="text-xs text-slate-400 font-mono">PR: ${maxWeight}</span>
                                        </div>
                                        <button onclick="toggleExerciseSkip(${exIndex})" class="text-xs font-bold px-3 py-1.5 rounded-lg border transition ${isSkipped ? 'bg-slate-700 text-white border-slate-500' : 'bg-slate-800 text-slate-400 border-slate-700 hover:text-white hover:border-slate-500'}">
                                            <i class="fa-solid ${isSkipped ? 'fa-rotate-left' : 'fa-forward'} mr-1"></i> ${isSkipped ? 'Desfazer' : 'Pular'}
                                        </button>
                                    </div>
                                    
                                    <div class="space-y-4 py-2 ${isSkipped ? 'pointer-events-none' : ''}" id="sets-container-${exIndex}">
                                        ${renderSetsHTML(exIndex)}
                                    </div>

                                    <button onclick="addSet(${exIndex})" ${isSkipped ? 'disabled' : ''} class="w-full py-3 bg-slate-800 hover:bg-slate-700 text-blue-400 font-semibold text-sm rounded-xl border border-dashed border-slate-600 hover:border-blue-500 transition flex items-center justify-center gap-2 group disabled:opacity-50 disabled:cursor-not-allowed">
                                        <i class="fa-solid fa-plus group-hover:scale-110 transition-transform"></i> Adicionar Série
                                    </button>
                                </div>
                            `;
                        });

                        html += `
                            <div class="pt-4 space-y-3">
                                <button onclick="finishSession()" class="w-full bg-blue-600 text-white font-bold py-4 rounded-xl shadow-lg shadow-blue-900/20 text-lg hover:bg-blue-500 active:scale-[0.98] transition">
                                    <i class="fa-solid fa-check-double mr-2"></i> FINALIZAR TREINO
                                </button>
                                <button onclick="cancelSession()" class="w-full text-slate-400 py-3 text-sm hover:text-white transition">
                                    Cancelar Treino
                                </button>
                            </div>
                        </div>`;

                        container.innerHTML = html;
                    };

                    // Helper para gerar HTML de todos os sets de um exercício
                    const renderSetsHTML = (exIndex) => {
                        const exData = sessionData.exercises[exIndex];
                        return exData.sets.map((set, setIndex) => generateSetHTML(exIndex, setIndex, set, exData.activeSetIndex === setIndex)).join('');
                    };

                    // Helper para gerar HTML de um set individual
                    const generateSetHTML = (exIndex, setIndex, set, isActive) => {
                        const isDone = set.done;
                        
                        // Estilos baseados no estado (Ativo vs Inativo vs Done)
                        let wrapperClass = "flex items-center gap-3 p-3 rounded-xl border transition-all duration-300 ease-out origin-center ";
                        let bgClass = "";
                        
                        if (isActive) {
                            wrapperClass += "scale-105 z-10 shadow-xl ring-1 ring-blue-500/50 ";
                            bgClass = isDone ? "bg-emerald-900/30 border-emerald-500" : "bg-slate-800 border-blue-500/50";
                        } else {
                            wrapperClass += "scale-95 opacity-60 blur-[0.5px] grayscale-[0.3] hover:opacity-100 hover:scale-100 hover:blur-0 hover:grayscale-0 ";
                            bgClass = isDone ? "bg-emerald-900/20 border-emerald-500/30" : "bg-slate-800/50 border-slate-700";
                        }

                        return `
                            <div id="set-row-${exIndex}-${setIndex}" class="${wrapperClass} ${bgClass}" onclick="setActiveSet(${exIndex}, ${setIndex})">
                                
                                <div class="flex flex-col items-center justify-center w-8">
                                    <span class="text-xs font-bold text-slate-500 mb-1">SET</span>
                                    <span class="text-lg font-mono font-bold ${isDone ? 'text-emerald-400' : 'text-slate-300'}">${setIndex + 1}</span>
                                </div>

                                <div class="flex-1 grid grid-cols-2 gap-3">
                                    <div class="relative">
                                        <input type="number" value="${set.weight}" inputmode="decimal" aria-label="Peso em kg"
                                            oninput="updateSet(${exIndex}, ${setIndex}, 'weight', this.value)" 
                                            onfocus="setActiveSet(${exIndex}, ${setIndex})"
                                            class="w-full bg-slate-900/50 border ${isDone ? 'border-emerald-500/30 text-emerald-100' : 'border-slate-600 text-white'} rounded-lg py-2.5 pl-3 pr-8 font-mono text-lg focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition-colors">
                                        <span class="absolute right-3 top-1/2 -translate-y-1/2 text-xs text-slate-500 font-bold pointer-events-none">KG</span>
                                    </div>
                                    <div class="relative">
                                        <input type="number" value="${set.reps}" inputmode="numeric" aria-label="Repetições"
                                            oninput="updateSet(${exIndex}, ${setIndex}, 'reps', this.value)"
                                            onfocus="setActiveSet(${exIndex}, ${setIndex})" 
                                            class="w-full bg-slate-900/50 border ${isDone ? 'border-emerald-500/30 text-emerald-100' : 'border-slate-600 text-white'} rounded-lg py-2.5 pl-3 pr-8 font-mono text-lg focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition-colors">
                                        <span class="absolute right-3 top-1/2 -translate-y-1/2 text-xs text-slate-500 font-bold pointer-events-none">R</span>
                                    </div>
                                </div>

                                <button id="btn-check-${exIndex}-${setIndex}" onclick="toggleSetDone(event, ${exIndex}, ${setIndex})" aria-label="Marcar série como concluída"
                                    class="w-12 h-12 rounded-full flex items-center justify-center transition-all duration-200 shadow-md active:scale-90 shrink-0 ${isDone ? 'bg-emerald-500 text-white shadow-emerald-900/50' : 'bg-slate-700 text-slate-400 hover:bg-slate-600'}">
                                    <i class="fa-solid fa-check text-xl"></i>
                                </button>
                            </div>
                        `;
                    };

                    window.addSet = (exIndex) => {
                        const exData = store.activeSession.current.exercises[exIndex];
                        const prevSet = exData.sets[exData.sets.length - 1];
                        const newSet = { 
                            weight: prevSet ? prevSet.weight : '', 
                            reps: prevSet ? prevSet.reps : '', 
                            done: false 
                        };
                        exData.sets.push(newSet);
                        exData.activeSetIndex = exData.sets.length - 1;
                        store.activeSession.saveSession(); // PERSISTENCIA
                        document.getElementById(`sets-container-${exIndex}`).innerHTML = renderSetsHTML(exIndex);
                    };

                    window.setActiveSet = (exIndex, setIndex) => {
                        if (store.activeSession.current.exercises[exIndex].activeSetIndex === setIndex) return;
                        store.activeSession.current.exercises[exIndex].activeSetIndex = setIndex;
                        const container = document.getElementById(`sets-container-${exIndex}`);
                        const rows = container.children;
                        for (let i = 0; i < rows.length; i++) {
                            const row = rows[i];
                            const isActive = (i === setIndex);
                            const isDone = store.activeSession.current.exercises[exIndex].sets[i].done;
                            let wrapperClass = "flex items-center gap-3 p-3 rounded-xl border transition-all duration-300 ease-out origin-center ";
                            let bgClass = "";
                            if (isActive) {
                                wrapperClass += "scale-105 z-10 shadow-xl ring-1 ring-blue-500/50 ";
                                bgClass = isDone ? "bg-emerald-900/30 border-emerald-500" : "bg-slate-800 border-blue-500/50";
                            } else {
                                wrapperClass += "scale-95 opacity-60 blur-[0.5px] grayscale-[0.3] hover:opacity-100 hover:scale-100 hover:blur-0 hover:grayscale-0 ";
                                bgClass = isDone ? "bg-emerald-900/20 border-emerald-500/30" : "bg-slate-800/50 border-slate-700";
                            }
                            row.className = wrapperClass + bgClass;
                        }
                    };

                    window.updateSet = (exIndex, setIndex, field, value) => {
                        store.activeSession.current.exercises[exIndex].sets[setIndex][field] = value;
                        store.activeSession.saveSession(); // PERSISTENCIA
                    };

                    window.toggleExerciseSkip = (exIndex) => {
                        const exData = store.activeSession.current.exercises[exIndex];
                        exData.skipped = !exData.skipped;
                        store.activeSession.saveSession(); // PERSISTENCIA
                        const isSkipped = exData.skipped;
                        const block = document.getElementById(`exercise-block-${exIndex}`);
                        const setsContainer = document.getElementById(`sets-container-${exIndex}`);
                        const titleContainer = block.querySelector('h3');
                        const skipBtn = block.querySelector('button[onclick^="toggleExerciseSkip"]');
                        const addSetBtn = block.querySelector('button[onclick^="addSet"]');
                        if (isSkipped) block.classList.add('opacity-50', 'grayscale'); else block.classList.remove('opacity-50', 'grayscale');
                        skipBtn.className = `text-xs font-bold px-3 py-1.5 rounded-lg border transition ${isSkipped ? 'bg-slate-700 text-white border-slate-500' : 'bg-slate-800 text-slate-400 border-slate-700 hover:text-white hover:border-slate-500'}`;
                        skipBtn.innerHTML = `<i class="fa-solid ${isSkipped ? 'fa-rotate-left' : 'fa-forward'} mr-1"></i> ${isSkipped ? 'Desfazer' : 'Pular'}`;
                    // 3. Badge "Pulado"
                    const badge = titleContainer.querySelector('.skipped-badge');
                    if (isSkipped && !badge) {
                        titleContainer.insertAdjacentHTML('beforeend', ' <span class="skipped-badge ml-2 px-3 py-1 bg-slate-700/80 text-slate-300 text-[10px] font-bold uppercase tracking-wider rounded-full border border-slate-600 shadow-sm backdrop-blur-sm fade-in">Pulado</span>');
                    } else if (!isSkipped && badge) {
                        badge.remove();
                    }
                        if (isSkipped) setsContainer.classList.add('pointer-events-none'); else setsContainer.classList.remove('pointer-events-none');
                        addSetBtn.disabled = isSkipped;
                        if(isSkipped) addSetBtn.classList.add('opacity-50', 'cursor-not-allowed'); else addSetBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    };

                    window.toggleSetDone = (event, exIndex, setIndex) => {
                        event.stopPropagation();
                        const exData = store.activeSession.current.exercises[exIndex];
                        const set = exData.sets[setIndex];
                        if (!set.done && (!set.reps || set.reps <= 0)) {
                            ui.showToast("Preencha as repetições antes de marcar como feito.", "error");
                            return;
                        }
                        set.done = !set.done;
                        store.activeSession.saveSession(); // PERSISTENCIA
                        if (set.done && setIndex < exData.sets.length - 1) setActiveSet(exIndex, setIndex + 1);
                        else setActiveSet(exIndex, setIndex);
                        const btn = document.getElementById(`btn-check-${exIndex}-${setIndex}`);
                        const indexLabel = document.querySelector(`#set-row-${exIndex}-${setIndex} .font-mono.font-bold`);
                        const inputs = document.querySelectorAll(`#set-row-${exIndex}-${setIndex} input`);
                        if (set.done) {
                            btn.className = 'w-12 h-12 rounded-full flex items-center justify-center transition-all duration-200 shadow-md active:scale-90 shrink-0 bg-emerald-500 text-white shadow-emerald-900/50';
                            if(indexLabel) indexLabel.classList.replace('text-slate-300', 'text-emerald-400');
                            inputs.forEach(input => { input.classList.remove('border-slate-600', 'text-white'); input.classList.add('border-emerald-500/30', 'text-emerald-100'); });
                        } else {
                            btn.className = 'w-12 h-12 rounded-full flex items-center justify-center transition-all duration-200 shadow-md active:scale-90 shrink-0 bg-slate-700 text-slate-400 hover:bg-slate-600';
                            if(indexLabel) indexLabel.classList.replace('text-emerald-400', 'text-slate-300');
                            inputs.forEach(input => { input.classList.remove('border-emerald-500/30', 'text-emerald-100'); input.classList.add('border-slate-600', 'text-white'); });
                        }
                    };

                    window.finishSession = () => {
                        const incompleteExercises = sessionData.exercises.filter(ex => {
                            if (ex.skipped) return false;
                            const hasDoneSets = ex.sets.some(s => s.done);
                            return !hasDoneSets;
                        });

                        if (incompleteExercises.length > 0) {
                            const names = incompleteExercises.map(ex => {
                                const def = exerciseDB.find(d => d.id === ex.id);
                                return def ? def.name : 'Exercício';
                            }).join(', ');
                            
                            ui.showModal({
                                title: 'Exercícios Pendentes',
                                message: `Você ainda não concluiu os seguintes exercícios: ${names}. Marque pelo menos uma série como feita ou pule o exercício para finalizar.`,
                                type: 'info'
                            });
                            return;
                        }

                        ui.showModal({
                            title: 'Finalizar Treino',
                            message: 'Parabéns! Deseja finalizar e salvar o treino agora?',
                            type: 'success',
                            confirmText: 'Salvar Treino',
                            onConfirm: () => {
                                const cleanDetails = sessionData.exercises
                                    .filter(ex => !ex.skipped)
                                    .map(ex => ({
                                        exerciseId: ex.id,
                                        sets: ex.sets.filter(s => s.done)
                                    }))
                                    .filter(ex => ex.sets.length > 0);

                                const log = {
                                    id: Date.now().toString(),
                                    workoutId: plan.id,
                                    planName: plan.name,
                                    date: new Date().toISOString(),
                                    duration: Math.floor((Date.now() - sessionData.startTime) / 1000),
                                    details: cleanDetails
                                };

                                store.saveLog(log);
                                store.activeSession.end(); // Limpa estado e esconde aba
                                ui.showToast('Treino salvo com sucesso!');
                                router.navigate('history');
                            }
                        });
                    };

                    window.cancelSession = () => {
                        ui.showModal({
                            title: 'Cancelar Treino',
                            message: 'Tem certeza? Todo o progresso deste treino será perdido.',
                            type: 'danger',
                            confirmText: 'Sim, Cancelar',
                            onConfirm: () => {
                                store.activeSession.end();
                                router.navigate('home');
                                ui.showToast('Treino cancelado', 'info');
                            }
                        });
                    };

                    renderInitialSession();
                }
            },

            // --- VIEW: HISTÓRICO ---
            renderHistory(container) {
                if (store.data.logs.length === 0) {
                    container.innerHTML = `
                        <div class="flex flex-col items-center justify-center h-full text-slate-500 fade-in">
                            <i class="fa-solid fa-clock-rotate-left text-6xl mb-4"></i>
                            <p>Sem histórico ainda.</p>
                        </div>`;
                    return;
                }

                let html = `<div class="space-y-4 fade-in">`;
                
                store.data.logs.forEach(log => {
                    const date = new Date(log.date);
                    const dateStr = date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: '2-digit' });
                    const timeStr = date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                    const durationMin = Math.floor(log.duration / 60);

                    const totalVolume = log.details.reduce((acc, ex) => {
                        return acc + ex.sets.reduce((sAcc, s) => sAcc + (s.weight * s.reps), 0);
                    }, 0);

                    html += `
                        <div class="bg-slate-800 rounded-lg p-4 border border-slate-700 shadow-sm">
                            <div class="flex justify-between items-start border-b border-slate-700 pb-2 mb-2">
                                <div>
                                    <h3 class="font-bold text-white">${log.planName}</h3>
                                    <p class="text-xs text-slate-400">${dateStr} às ${timeStr}</p>
                                </div>
                                <div class="text-right">
                                    <span class="block text-blue-400 font-bold text-sm"><i class="fa-solid fa-stopwatch mr-1"></i>${durationMin} min</span>
                                    <span class="text-xs text-slate-500">Vol: ${totalVolume}kg</span>
                                </div>
                            </div>
                            <div class="space-y-1">
                                ${log.details.map(d => {
                                    const exName = exerciseDB.find(db => db.id === d.exerciseId)?.name || 'Exer';
                                    const bestSet = d.sets.reduce((prev, current) => (prev.weight > current.weight) ? prev : current, {weight:0});
                                    return `
                                        <div class="flex justify-between text-sm text-slate-300">
                                            <span>${d.sets.length}x ${exName}</span>
                                            <span class="text-slate-500">Max: ${bestSet.weight}kg</span>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                });
                html += `</div>`;
                container.innerHTML = html;
            },

            // --- VIEW: EXERCÍCIOS (Consulta) ---
            renderExercises(container) {
                container.innerHTML = `
                    <div class="fade-in space-y-4">
                        <div class="relative">
                            <i class="fa-solid fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-500"></i>
                            <input type="text" id="ex-search-input" aria-label="Pesquisar exercícios" placeholder="Buscar exercício (ex: Supino)..." class="w-full bg-slate-800 border border-slate-700 rounded-xl p-3 pl-11 text-white focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition">
                        </div>
                        <div id="ex-list-full" class="space-y-3 pb-20"></div>
                    </div>
                `;

                const categoryIcons = {
                    'Peitoral': 'fa-dumbbell',
                    'Costas': 'fa-child-reaching',
                    'Pernas': 'fa-person-running',
                    'Ombros': 'fa-user-ninja',
                    'Bíceps': 'fa-hand-fist',
                    'Tríceps': 'fa-hand-back-fist',
                    'Abdômen': 'fa-table-cells',
                    'Cardio': 'fa-heart-pulse',
                    'Alongamento': 'fa-person-praying'
                };

                const renderFullList = (filter = '') => {
                    const el = document.getElementById('ex-list-full');
                    el.innerHTML = '';
                    
                    const isSearching = filter.length > 0;
                    const cleanFilter = filter.toLowerCase();

                    // Agrupar por Categoria
                    const groups = {};
                    exerciseDB.forEach(ex => {
                        // Filtra
                        if (isSearching) {
                            const matchName = ex.name.toLowerCase().includes(cleanFilter);
                            const matchCat = ex.category.toLowerCase().includes(cleanFilter);
                            if (!matchName && !matchCat) return;
                        }

                        if(!groups[ex.category]) groups[ex.category] = [];
                        groups[ex.category].push(ex);
                    });

                    const categories = Object.keys(groups);

                    if (categories.length === 0) {
                        el.innerHTML = `
                            <div class="text-center text-slate-500 py-8">
                                <i class="fa-solid fa-dumbbell text-4xl mb-3 opacity-20"></i>
                                <p>Nenhum exercício encontrado.</p>
                            </div>
                        `;
                        return;
                    }

                    categories.forEach(cat => {
                        const exercises = groups[cat];
                        const icon = categoryIcons[cat] || 'fa-dumbbell';
                        const isOpen = isSearching; // Abre tudo se estiver pesquisando

                        // Container da Categoria
                        const catContainer = document.createElement('div');
                        catContainer.className = 'bg-slate-800 rounded-xl overflow-hidden border border-slate-700 transition-all duration-300';
                        
                        // Header (Botão Accordion)
                        const header = document.createElement('button');
                        header.className = 'w-full px-4 py-4 flex justify-between items-center bg-slate-800 hover:bg-slate-750 transition active:bg-slate-700 text-left';
                        header.onclick = () => {
                            const list = document.getElementById(`list-${cat}`);
                            const chevron = document.getElementById(`chevron-${cat}`);
                            list.classList.toggle('hidden');
                            chevron.classList.toggle('rotate-180');
                        };

                        header.innerHTML = `
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-lg bg-blue-900/30 flex items-center justify-center text-blue-400">
                                    <i class="fa-solid ${icon}"></i>
                                </div>
                                <span class="font-bold text-slate-200">${cat}</span>
                                <span class="text-xs text-slate-500 bg-slate-900 px-2 py-0.5 rounded-full">${exercises.length}</span>
                            </div>
                            <i id="chevron-${cat}" class="fa-solid fa-chevron-down text-slate-500 transition-transform duration-300 ${isOpen ? 'rotate-180' : ''}"></i>
                        `;

                        // Lista de Itens
                        const list = document.createElement('div');
                        list.id = `list-${cat}`;
                        list.className = `divide-y divide-slate-700/50 bg-slate-900/30 ${isOpen ? '' : 'hidden'}`;
                        
                        exercises.forEach(ex => {
                            const item = document.createElement('div');
                            item.className = 'px-4 py-3 text-sm text-slate-300 flex items-center gap-2 hover:bg-slate-700/30 transition';
                            item.innerHTML = `<i class="fa-solid fa-caret-right text-xs text-blue-500/50"></i> ${ex.name}`;
                            list.appendChild(item);
                        });

                        catContainer.appendChild(header);
                        catContainer.appendChild(list);
                        el.appendChild(catContainer);
                    });
                };

                document.getElementById('ex-search-input').addEventListener('input', (e) => renderFullList(e.target.value));
                renderFullList();
            },

            // --- VIEW: CONFIGURAÇÕES / DADOS ---
            renderSettings(container) {
                container.innerHTML = `
                    <div class="fade-in space-y-6">
                        <div class="bg-slate-800 p-4 rounded-xl border border-slate-700">
                            <h3 class="text-lg font-bold text-white mb-2">Gerenciar Dados</h3>
                            <p class="text-sm text-slate-400 mb-4">Exporte seus treinos para salvar um backup ou importe em outro dispositivo.</p>
                            
                            <div class="space-y-4">
                                <!-- Opções de Exportação -->
                                <div class="grid grid-cols-1 sm:grid-cols-3 gap-2">
                                    <button onclick="store.exportData('all')" class="bg-blue-600 hover:bg-blue-500 text-white py-3 px-2 rounded-lg text-sm font-bold transition flex items-center justify-center gap-2">
                                        <i class="fa-solid fa-download"></i> Tudo
                                    </button>
                                    <button onclick="store.exportData('history')" class="bg-slate-700 hover:bg-slate-600 text-white py-3 px-2 rounded-lg text-sm font-bold transition flex items-center justify-center gap-2">
                                        <i class="fa-solid fa-clock-rotate-left"></i> Só Histórico
                                    </button>
                                    <button onclick="ui.showPlanSelectionModal()" class="bg-slate-700 hover:bg-slate-600 text-white py-3 px-2 rounded-lg text-sm font-bold transition flex items-center justify-center gap-2">
                                        <i class="fa-solid fa-clipboard-list"></i> Só Planos
                                    </button>
                                </div>

                                <!-- Importação -->
                                <label aria-label="Importar dados de arquivo JSON" class="w-full bg-slate-700 hover:bg-slate-600 text-white py-4 rounded-xl flex flex-col items-center justify-center gap-2 cursor-pointer transition active:scale-95 border border-dashed border-slate-500 hover:border-white">
                                    <i class="fa-solid fa-upload text-xl"></i>
                                    <span class="font-bold">Importar Arquivo JSON</span>
                                    <span class="text-xs text-slate-400 font-normal">Restaura planos, histórico ou ambos</span>
                                    <input type="file" id="import-file" class="hidden" accept=".json" onchange="store.importData(this.files[0])">
                                </label>
                            </div>
                        </div>

                        <div class="bg-slate-800 p-4 rounded-xl border border-slate-700">
                            <h3 class="text-lg font-bold text-white mb-2">Sobre</h3>
                            <p class="text-sm text-slate-400">IronTrack v1.0</p>
                            <p class="text-xs text-slate-500 mt-2">Armazenamento local em uso: ${(JSON.stringify(store.data).length / 1024).toFixed(2)} KB</p>
                            
                            <button onclick="ui.showModal({ title: 'Apagar Tudo', message: 'Tem certeza absoluta? Todos os seus treinos e histórico serão apagados permanentemente.', type: 'danger', confirmText: 'Sim, Apagar Tudo', onConfirm: () => { localStorage.removeItem('ironTrackData'); localStorage.removeItem('ironTrackActiveSession'); location.reload(); } })" class="mt-4 text-red-500 text-xs hover:text-red-400 underline cursor-pointer">
                                Resetar todos os dados
                            </button>
                        </div>
                    </div>
                `;
            }
        };

        // Inicialização
        document.addEventListener('DOMContentLoaded', () => {
            store.init();
            router.navigate('home');
        });

    </script>
</body>
</html>
