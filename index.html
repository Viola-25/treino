<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>IronTrack - Diário de Treino</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #e2e8f0; }
        
        /* Ocultar barra de rolagem mas permitir scroll */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Animações simples */
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Estilo para inputs numéricos */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        
        /* Safe area para iPhones */
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body class="h-screen w-full overflow-hidden flex flex-col items-center justify-center bg-slate-900">

    <!-- Container Principal -->
    <div class="w-full max-w-md h-full flex flex-col bg-slate-900 shadow-2xl relative overflow-hidden">
        
        <!-- Header -->
        <header class="bg-slate-800 p-4 shadow-md z-10 flex justify-between items-center border-b border-slate-700">
            <h1 class="text-xl font-bold text-blue-400 tracking-wide"><i class="fa-solid fa-dumbbell mr-2"></i>IronTrack</h1>
            <div id="header-actions">
                <!-- Botões dinâmicos aparecerão aqui -->
            </div>
        </header>

        <!-- Área de Conteúdo (Scrollável) -->
        <main id="app-content" class="flex-1 overflow-y-auto no-scrollbar p-4 pb-24 relative">
            <!-- O conteúdo das views será injetado aqui pelo JS -->
        </main>

        <!-- Barra de Navegação Inferior -->
        <nav class="bg-slate-800 border-t border-slate-700 p-2 safe-bottom z-20">
            <div class="flex justify-around items-center h-14">
                <button onclick="router.navigate('home')" aria-label="Ir para Treinos" class="nav-btn flex flex-col items-center text-slate-400 hover:text-blue-400 active:text-blue-500 transition w-full" data-target="home">
                    <i class="fa-solid fa-house text-xl mb-1"></i>
                    <span class="text-xs">Treinos</span>
                </button>
                <button onclick="router.navigate('history')" aria-label="Ir para Histórico" class="nav-btn flex flex-col items-center text-slate-400 hover:text-blue-400 active:text-blue-500 transition w-full" data-target="history">
                    <i class="fa-solid fa-calendar-check text-xl mb-1"></i>
                    <span class="text-xs">Histórico</span>
                </button>
                <button onclick="router.navigate('exercises')" aria-label="Ir para Exercícios" class="nav-btn flex flex-col items-center text-slate-400 hover:text-blue-400 active:text-blue-500 transition w-full" data-target="exercises">
                    <i class="fa-solid fa-list-ul text-xl mb-1"></i>
                    <span class="text-xs">Exercícios</span>
                </button>
                <button onclick="router.navigate('settings')" aria-label="Ir para Configurações" class="nav-btn flex flex-col items-center text-slate-400 hover:text-blue-400 active:text-blue-500 transition w-full" data-target="settings">
                    <i class="fa-solid fa-gear text-xl mb-1"></i>
                    <span class="text-xs">Dados</span>
                </button>
            </div>
        </nav>

        <!-- Modais / Overlays -->
        <div id="modal-container" class="hidden absolute inset-0 bg-black/80 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
            <!-- Conteúdo do Modal Injetado aqui -->
        </div>

    </div>

    <!-- Scripts da Aplicação -->
    <script>
        // --- 1. BANCO DE DADOS DE EXERCÍCIOS ---
        const exerciseDB = [
            { id: 'peito_01', name: 'Supino Reto (Barra)', category: 'Peitoral' },
            { id: 'peito_02', name: 'Supino Inclinado (Halteres)', category: 'Peitoral' },
            { id: 'peito_03', name: 'Crucifixo', category: 'Peitoral' },
            { id: 'peito_04', name: 'Crossover Polia', category: 'Peitoral' },
            { id: 'peito_05', name: 'Flexão de Braço', category: 'Peitoral' },
            { id: 'costas_01', name: 'Puxada Alta', category: 'Costas' },
            { id: 'costas_02', name: 'Remada Curvada', category: 'Costas' },
            { id: 'costas_03', name: 'Remada Cavalinho', category: 'Costas' },
            { id: 'costas_04', name: 'Barra Fixa', category: 'Costas' },
            { id: 'costas_05', name: 'Levantamento Terra', category: 'Costas' },
            { id: 'pernas_01', name: 'Agachamento Livre', category: 'Pernas' },
            { id: 'pernas_02', name: 'Leg Press 45', category: 'Pernas' },
            { id: 'pernas_03', name: 'Cadeira Extensora', category: 'Pernas' },
            { id: 'pernas_04', name: 'Mesa Flexora', category: 'Pernas' },
            { id: 'pernas_05', name: 'Stiff', category: 'Pernas' },
            { id: 'pernas_06', name: 'Elevação Pélvica', category: 'Pernas' },
            { id: 'pernas_07', name: 'Panturrilha em Pé', category: 'Pernas' },
            { id: 'ombros_01', name: 'Desenvolvimento Militar', category: 'Ombros' },
            { id: 'ombros_02', name: 'Elevação Lateral', category: 'Ombros' },
            { id: 'ombros_03', name: 'Elevação Frontal', category: 'Ombros' },
            { id: 'ombros_04', name: 'Crucifixo Inverso', category: 'Ombros' },
            { id: 'biceps_01', name: 'Rosca Direta', category: 'Bíceps' },
            { id: 'biceps_02', name: 'Rosca Martelo', category: 'Bíceps' },
            { id: 'biceps_03', name: 'Rosca Scott', category: 'Bíceps' },
            { id: 'triceps_01', name: 'Tríceps Polia (Corda)', category: 'Tríceps' },
            { id: 'triceps_02', name: 'Tríceps Testa', category: 'Tríceps' },
            { id: 'triceps_03', name: 'Mergulho (Paralelas)', category: 'Tríceps' },
            { id: 'abs_01', name: 'Abdominal Supra', category: 'Abdômen' },
            { id: 'abs_02', name: 'Prancha', category: 'Abdômen' },
            { id: 'abs_03', name: 'Elevação de Pernas', category: 'Abdômen' },
            { id: 'cardio_01', name: 'Esteira', category: 'Cardio' },
            { id: 'cardio_02', name: 'Bicicleta', category: 'Cardio' },
            { id: 'cardio_03', name: 'Elíptico', category: 'Cardio' },
            { id: 'cardio_04', name: 'Pular Corda', category: 'Cardio' },
            { id: 'along_01', name: 'Alongamento Geral', category: 'Alongamento' }
        ];

        // --- 2. GESTÃO DE ESTADO E DADOS ---
        const store = {
            data: {
                plans: [], // { id, name, exercises: [] }
                logs: [],  // { id, date, planName, details: [] }
                version: 1.0
            },
            
            init() {
                const saved = localStorage.getItem('ironTrackData');
                if (saved) {
                    try {
                        this.data = JSON.parse(saved);
                    } catch (e) {
                        console.error("Erro ao carregar dados", e);
                    }
                } else {
                    // Dados iniciais de exemplo
                    this.createPlan("Treino A - Peito e Tríceps", ['peito_01', 'peito_02', 'triceps_01']);
                    this.createPlan("Treino B - Costas e Bíceps", ['costas_01', 'costas_02', 'biceps_01']);
                }
            },

            save() {
                localStorage.setItem('ironTrackData', JSON.stringify(this.data));
            },

            createPlan(name, exerciseIds) {
                const newPlan = {
                    id: Date.now().toString(),
                    name: name,
                    exercises: exerciseIds.map(id => ({ id: id, sets: 3, targetReps: 10 }))
                };
                this.data.plans.push(newPlan);
                this.save();
            },

            updatePlan(id, name, exerciseIds) {
                const planIndex = this.data.plans.findIndex(p => p.id === id);
                if (planIndex !== -1) {
                    this.data.plans[planIndex].name = name;
                    this.data.plans[planIndex].exercises = exerciseIds.map(id => ({ id: id, sets: 3, targetReps: 10 }));
                    this.save();
                }
            },

            deletePlan(id) {
                this.data.plans = this.data.plans.filter(p => p.id !== id);
                this.save();
            },

            saveLog(log) {
                this.data.logs.unshift(log); // Adiciona no início
                this.save();
            },

            exportData() {
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(this.data));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", "irontrack_backup_" + new Date().toISOString().slice(0,10) + ".json");
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
            },

            importData(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const imported = JSON.parse(e.target.result);
                        if(imported.plans && imported.logs) {
                            this.data = imported;
                            this.save();
                            alert('Dados importados com sucesso!');
                            router.navigate('home');
                        } else {
                            alert('Arquivo inválido.');
                        }
                    } catch (ex) {
                        alert('Erro ao ler arquivo JSON.');
                    }
                };
                reader.readAsText(file);
            }
        };

        // --- 3. ROTEAMENTO E VIEWS ---
        const router = {
            currentView: 'home',
            
            navigate(view, params = null) {
                this.currentView = view;
                
                // Atualiza abas
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    if(btn.dataset.target === view) {
                        btn.classList.add('text-blue-400');
                        btn.classList.remove('text-slate-400');
                    } else if (['home', 'history', 'exercises', 'settings'].includes(view)) {
                        // Só limpa se for navegar para uma das abas principais
                        if (['home', 'history', 'exercises', 'settings'].includes(btn.dataset.target)) {
                            btn.classList.remove('text-blue-400');
                            btn.classList.add('text-slate-400');
                        }
                    }
                });

                const content = document.getElementById('app-content');
                const actions = document.getElementById('header-actions');
                
                content.innerHTML = '';
                actions.innerHTML = '';

                switch(view) {
                    case 'home':
                        this.renderHome(content, actions);
                        break;
                    case 'create-plan':
                        this.renderCreatePlan(content, actions);
                        break;
                    case 'active-session':
                        this.renderActiveSession(content, actions, params);
                        break;
                    case 'history':
                        this.renderHistory(content);
                        break;
                    case 'exercises':
                        this.renderExercises(content);
                        break;
                    case 'settings':
                        this.renderSettings(content);
                        break;
                }
            },

            // --- VIEW: HOME (Listagem de Planos) ---
            renderHome(container, headerActions) {
                headerActions.innerHTML = `
                    <button onclick="router.navigate('create-plan')" class="bg-blue-600 hover:bg-blue-500 text-white px-3 py-1 rounded font-bold text-sm transition">
                        <i class="fa-solid fa-plus mr-1"></i> Novo Treino
                    </button>
                `;

                if (store.data.plans.length === 0) {
                    container.innerHTML = `
                        <div class="flex flex-col items-center justify-center h-full text-slate-500 fade-in">
                            <i class="fa-solid fa-clipboard-list text-6xl mb-4"></i>
                            <p>Nenhum plano de treino.</p>
                            <p class="text-sm">Crie um novo para começar!</p>
                        </div>
                    `;
                    return;
                }

                let html = `<div class="space-y-4 fade-in">`;
                store.data.plans.forEach(plan => {
                    const exerciseCount = plan.exercises.length;
                    const exerciseNames = plan.exercises.slice(0, 3).map(e => {
                        const exDef = exerciseDB.find(db => db.id === e.id);
                        return exDef ? exDef.name : 'Exer';
                    }).join(', ') + (exerciseCount > 3 ? '...' : '');

                    html += `
                        <div class="bg-slate-800 rounded-xl p-4 shadow-lg border border-slate-700 relative group">
                            <div class="flex justify-between items-start mb-2">
                                <h3 class="text-lg font-bold text-white">${plan.name}</h3>
                                <div class="flex gap-2">
                                    <button onclick="router.navigate('create-plan', '${plan.id}')" aria-label="Editar plano" class="text-blue-400 hover:text-blue-300 p-2 rounded-full hover:bg-blue-900/30 transition">
                                        <i class="fa-solid fa-pen"></i>
                                    </button>
                                    <button onclick="store.deletePlan('${plan.id}'); router.navigate('home')" aria-label="Excluir plano" class="text-red-400 hover:text-red-300 p-2 rounded-full hover:bg-red-900/30 transition">
                                        <i class="fa-solid fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <p class="text-slate-400 text-sm mb-4 h-10 overflow-hidden text-ellipsis">${exerciseNames}</p>
                            <button onclick="router.navigate('active-session', '${plan.id}')" class="w-full bg-blue-600 hover:bg-blue-500 active:scale-95 text-white font-bold py-3 rounded-lg transition flex items-center justify-center">
                                <i class="fa-solid fa-play mr-2"></i> INICIAR TREINO
                            </button>
                        </div>
                    `;
                });
                html += `</div>`;
                container.innerHTML = html;
            },

            // --- VIEW: CRIAR/EDITAR PLANO ---
            renderCreatePlan(container, headerActions, planId = null) {
                headerActions.innerHTML = `
                    <button onclick="router.navigate('home')" class="text-slate-400 hover:text-white text-sm">Cancelar</button>
                `;

                let selectedExercises = [];
                let planToEdit = null;
                
                if (planId) {
                    planToEdit = store.data.plans.find(p => p.id === planId);
                    if (planToEdit) {
                        selectedExercises = planToEdit.exercises.map(e => e.id);
                    }
                }

                container.innerHTML = `
                    <div class="fade-in space-y-4">
                        <h2 class="text-xl font-bold text-white mb-2">${planToEdit ? 'Editar Treino' : 'Novo Treino'}</h2>
                        <div>
                            <label class="block text-sm font-medium text-slate-400 mb-1">Nome do Treino</label>
                            <input type="text" id="plan-name" value="${planToEdit ? planToEdit.name : ''}" placeholder="Ex: Costas e Bíceps" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-white focus:border-blue-500 focus:outline-none transition">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-slate-400 mb-1">Selecionar Exercícios</label>
                            <input type="text" id="search-ex" aria-label="Buscar exercício para adicionar" placeholder="Buscar exercício..." class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-white mb-2 text-sm focus:border-blue-500 outline-none transition">
                            
                            <div id="exercise-list" class="h-64 overflow-y-auto bg-slate-800 rounded-lg border border-slate-700 p-2 space-y-1">
                                <!-- Lista populada via JS -->
                            </div>
                        </div>

                        <div id="selected-list" class="bg-slate-800/50 p-3 rounded-lg min-h-[50px] border border-dashed border-slate-600">
                            <p class="text-xs text-slate-500 text-center italic">Nenhum exercício selecionado</p>
                        </div>

                        <button id="save-plan-btn" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg mt-4 opacity-50 cursor-not-allowed" disabled>
                            ${planToEdit ? 'ATUALIZAR PLANO' : 'SALVAR PLANO'}
                        </button>
                    </div>
                `;

                // Logica do Search
                const listEl = document.getElementById('exercise-list');
                const searchInput = document.getElementById('search-ex');
                const selectedEl = document.getElementById('selected-list');
                const saveBtn = document.getElementById('save-plan-btn');

                const renderList = (filter = '') => {
                    listEl.innerHTML = '';
                    const filtered = exerciseDB.filter(e => e.name.toLowerCase().includes(filter.toLowerCase()) || e.category.toLowerCase().includes(filter.toLowerCase()));
                    
                    filtered.forEach(ex => {
                        const isSelected = selectedExercises.includes(ex.id);
                        const item = document.createElement('div');
                        item.className = `p-2 rounded cursor-pointer flex justify-between items-center ${isSelected ? 'bg-blue-900/30 text-blue-400' : 'hover:bg-slate-700 text-slate-300'}`;
                        item.innerHTML = `<span>${ex.name} <small class="text-slate-500 ml-2">(${ex.category})</small></span> ${isSelected ? '<i class="fa-solid fa-check"></i>' : ''}`;
                        item.onclick = () => toggleSelect(ex.id);
                        listEl.appendChild(item);
                    });
                };

                const toggleSelect = (id) => {
                    if (selectedExercises.includes(id)) {
                        selectedExercises = selectedExercises.filter(e => e !== id);
                    } else {
                        selectedExercises.push(id);
                    }
                    renderList(searchInput.value);
                    updateSelectedView();
                };

                const updateSelectedView = () => {
                    if (selectedExercises.length === 0) {
                        selectedEl.innerHTML = '<p class="text-xs text-slate-500 text-center italic">Nenhum exercício selecionado</p>';
                        saveBtn.disabled = true;
                        saveBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    } else {
                        selectedEl.innerHTML = selectedExercises.map(id => {
                            const ex = exerciseDB.find(e => e.id === id);
                            return `<span class="inline-block bg-slate-700 text-xs px-2 py-1 rounded mr-1 mb-1 border border-slate-600">${ex.name}</span>`;
                        }).join('');
                        saveBtn.disabled = false;
                        saveBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                        saveBtn.classList.add('hover:bg-blue-500');
                    }
                };

                searchInput.addEventListener('input', (e) => renderList(e.target.value));
                
                saveBtn.addEventListener('click', () => {
                    const name = document.getElementById('plan-name').value || 'Treino Sem Nome';
                    if (planId) {
                        store.updatePlan(planId, name, selectedExercises);
                    } else {
                        store.createPlan(name, selectedExercises);
                    }
                    router.navigate('home');
                });

                renderList();
                updateSelectedView();
            },

            // --- VIEW: SESSÃO ATIVA (TREINO) ---
            renderActiveSession(container, headerActions, planId) {
                const plan = store.data.plans.find(p => p.id === planId);
                if (!plan) return router.navigate('home');

                // 1. Carregar dados do último treino (Persistência)
                const lastLog = store.data.logs.find(l => l.workoutId === plan.id || l.planName === plan.name);
                
                const initialExercises = plan.exercises.map(ex => {
                    let sets = [];
                    // Tenta carregar do histórico
                    if (lastLog) {
                        const lastEx = lastLog.details.find(d => d.exerciseId === ex.id);
                        if (lastEx && lastEx.sets.length > 0) {
                            sets = lastEx.sets.map(s => ({
                                weight: s.weight,
                                reps: s.reps,
                                done: false // Sempre começa como não feito
                            }));
                        }
                    }
                    
                    // Se não tiver histórico, inicia com 1 série vazia
                    if (sets.length === 0) {
                        sets.push({ weight: '', reps: '', done: false });
                    }
                    
                    return {
                        id: ex.id,
                        activeSetIndex: 0, // Estado do foco visual
                        skipped: false, // Estado de "Pular Exercício"
                        sets: sets
                    };
                });

                // Estado local da sessão
                let sessionData = {
                    startTime: Date.now(),
                    exercises: initialExercises
                };

                // Timer
                let timerInterval;
                const updateTimer = () => {
                    const now = Date.now();
                    const diff = Math.floor((now - sessionData.startTime) / 1000);
                    const m = Math.floor(diff / 60).toString().padStart(2, '0');
                    const s = (diff % 60).toString().padStart(2, '0');
                    const timerEl = document.getElementById('session-timer');
                    if(timerEl) timerEl.innerText = `${m}:${s}`;
                };

                headerActions.innerHTML = `<div id="session-timer" aria-label="Tempo de treino" class="font-mono text-xl text-blue-400 font-bold">00:00</div>`;
                timerInterval = setInterval(updateTimer, 1000);

                const renderInitialSession = () => {
                    let html = `<div class="pb-10 fade-in space-y-8">`;
                    
                    html += `<h2 class="text-2xl font-bold text-white mb-4 border-b border-slate-700 pb-4">${plan.name}</h2>`;

                    sessionData.exercises.forEach((sessionEx, exIndex) => {
                        const exDef = exerciseDB.find(db => db.id === sessionEx.id);
                        const isSkipped = sessionEx.skipped;
                        
                        // Encontra maior carga histórica para referência
                        let maxWeight = '-';
                        if(lastLog) {
                            const oldEx = lastLog.details.find(d => d.exerciseId === sessionEx.id);
                            if(oldEx && oldEx.sets.length > 0) {
                                maxWeight = Math.max(...oldEx.sets.map(s => Number(s.weight) || 0)) + 'kg';
                            }
                        }

                        html += `
                            <div id="exercise-block-${exIndex}" class="space-y-3 transition-all duration-300 ${isSkipped ? 'opacity-50 grayscale' : ''}">
                                <div class="flex justify-between items-center px-1">
                                    <div class="flex flex-col">
                                        <h3 class="font-bold text-xl text-blue-400 flex items-center gap-2">
                                            ${exDef.name}
                                            ${isSkipped ? '<span class="text-xs bg-slate-700 text-slate-300 px-2 py-0.5 rounded uppercase">Pulado</span>' : ''}
                                        </h3>
                                        <span class="text-xs text-slate-400 font-mono">PR: ${maxWeight}</span>
                                    </div>
                                    <button onclick="toggleExerciseSkip(${exIndex})" class="text-xs font-bold px-3 py-1.5 rounded-lg border transition ${isSkipped ? 'bg-slate-700 text-white border-slate-500' : 'bg-slate-800 text-slate-400 border-slate-700 hover:text-white hover:border-slate-500'}">
                                        <i class="fa-solid ${isSkipped ? 'fa-rotate-left' : 'fa-forward'} mr-1"></i> ${isSkipped ? 'Desfazer' : 'Pular'}
                                    </button>
                                </div>
                                
                                <div class="space-y-4 py-2 ${isSkipped ? 'pointer-events-none' : ''}" id="sets-container-${exIndex}">
                                    ${renderSetsHTML(exIndex)}
                                </div>

                                <button onclick="addSet(${exIndex})" ${isSkipped ? 'disabled' : ''} class="w-full py-3 bg-slate-800 hover:bg-slate-700 text-blue-400 font-semibold text-sm rounded-xl border border-dashed border-slate-600 hover:border-blue-500 transition flex items-center justify-center gap-2 group disabled:opacity-50 disabled:cursor-not-allowed">
                                    <i class="fa-solid fa-plus group-hover:scale-110 transition-transform"></i> Adicionar Série
                                </button>
                            </div>
                        `;
                    });

                    html += `
                        <div class="pt-4 space-y-3">
                            <button onclick="finishSession()" class="w-full bg-blue-600 text-white font-bold py-4 rounded-xl shadow-lg shadow-blue-900/20 text-lg hover:bg-blue-500 active:scale-[0.98] transition">
                                <i class="fa-solid fa-check-double mr-2"></i> FINALIZAR TREINO
                            </button>
                            <button onclick="cancelSession()" class="w-full text-slate-400 py-3 text-sm hover:text-white transition">
                                Cancelar Treino
                            </button>
                        </div>
                    </div>`;

                    container.innerHTML = html;
                };

                // Helper para gerar HTML de todos os sets de um exercício
                const renderSetsHTML = (exIndex) => {
                    const exData = sessionData.exercises[exIndex];
                    return exData.sets.map((set, setIndex) => generateSetHTML(exIndex, setIndex, set, exData.activeSetIndex === setIndex)).join('');
                };

                // Helper para gerar HTML de um set individual
                const generateSetHTML = (exIndex, setIndex, set, isActive) => {
                    const isDone = set.done;
                    
                    // Estilos baseados no estado (Ativo vs Inativo vs Done)
                    let wrapperClass = "flex items-center gap-3 p-3 rounded-xl border transition-all duration-300 ease-out origin-center ";
                    let bgClass = "";
                    
                    if (isActive) {
                        wrapperClass += "scale-105 z-10 shadow-xl ring-1 ring-blue-500/50 ";
                        bgClass = isDone ? "bg-emerald-900/30 border-emerald-500" : "bg-slate-800 border-blue-500/50";
                    } else {
                        wrapperClass += "scale-95 opacity-60 blur-[0.5px] grayscale-[0.3] hover:opacity-100 hover:scale-100 hover:blur-0 hover:grayscale-0 ";
                        bgClass = isDone ? "bg-emerald-900/20 border-emerald-500/30" : "bg-slate-800/50 border-slate-700";
                    }

                    return `
                        <div id="set-row-${exIndex}-${setIndex}" class="${wrapperClass} ${bgClass}" onclick="setActiveSet(${exIndex}, ${setIndex})">
                            
                            <div class="flex flex-col items-center justify-center w-8">
                                <span class="text-xs font-bold text-slate-500 mb-1">SET</span>
                                <span class="text-lg font-mono font-bold ${isDone ? 'text-emerald-400' : 'text-slate-300'}">${setIndex + 1}</span>
                            </div>

                            <div class="flex-1 grid grid-cols-2 gap-3">
                                <div class="relative">
                                    <input type="number" value="${set.weight}" inputmode="decimal" aria-label="Peso em kg"
                                        oninput="updateSet(${exIndex}, ${setIndex}, 'weight', this.value)" 
                                        onfocus="setActiveSet(${exIndex}, ${setIndex})"
                                        class="w-full bg-slate-900/50 border ${isDone ? 'border-emerald-500/30 text-emerald-100' : 'border-slate-600 text-white'} rounded-lg py-2.5 pl-3 pr-8 font-mono text-lg focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition-colors">
                                    <span class="absolute right-3 top-1/2 -translate-y-1/2 text-xs text-slate-500 font-bold pointer-events-none">KG</span>
                                </div>
                                <div class="relative">
                                    <input type="number" value="${set.reps}" inputmode="numeric" aria-label="Repetições"
                                        oninput="updateSet(${exIndex}, ${setIndex}, 'reps', this.value)"
                                        onfocus="setActiveSet(${exIndex}, ${setIndex})" 
                                        class="w-full bg-slate-900/50 border ${isDone ? 'border-emerald-500/30 text-emerald-100' : 'border-slate-600 text-white'} rounded-lg py-2.5 pl-3 pr-8 font-mono text-lg focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition-colors">
                                    <span class="absolute right-3 top-1/2 -translate-y-1/2 text-xs text-slate-500 font-bold pointer-events-none">R</span>
                                </div>
                            </div>

                            <button id="btn-check-${exIndex}-${setIndex}" onclick="toggleSetDone(event, ${exIndex}, ${setIndex})" aria-label="Marcar série como concluída"
                                class="w-12 h-12 rounded-full flex items-center justify-center transition-all duration-200 shadow-md active:scale-90 shrink-0 ${isDone ? 'bg-emerald-500 text-white shadow-emerald-900/50' : 'bg-slate-700 text-slate-400 hover:bg-slate-600'}">
                                <i class="fa-solid fa-check text-xl"></i>
                            </button>
                        </div>
                    `;
                };

                // Funções globais otimizadas
                window.addSet = (exIndex) => {
                    const exData = sessionData.exercises[exIndex];
                    const prevSet = exData.sets[exData.sets.length - 1];
                    
                    const newSet = { 
                        weight: prevSet ? prevSet.weight : '', 
                        reps: prevSet ? prevSet.reps : '', 
                        done: false 
                    };
                    
                    exData.sets.push(newSet);
                    // Novo set vira o ativo
                    exData.activeSetIndex = exData.sets.length - 1;
                    
                    // Re-renderiza a lista de sets deste exercício para aplicar estilos
                    const container = document.getElementById(`sets-container-${exIndex}`);
                    container.innerHTML = renderSetsHTML(exIndex);
                };

                window.setActiveSet = (exIndex, setIndex) => {
                    if (sessionData.exercises[exIndex].activeSetIndex === setIndex) return;
                    
                    sessionData.exercises[exIndex].activeSetIndex = setIndex;
                    const container = document.getElementById(`sets-container-${exIndex}`);
                    
                    // Atualização eficiente via innerHTML (Rápida o suficiente para < 10 items)
                    // Manter foco é tricky se recriar tudo.
                    // Melhor abordagem: Atualizar classes manualmente para não perder foco do input
                    
                    const rows = container.children;
                    for (let i = 0; i < rows.length; i++) {
                        const row = rows[i];
                        const isActive = (i === setIndex);
                        const isDone = sessionData.exercises[exIndex].sets[i].done;

                        // Recalcula classes
                        let wrapperClass = "flex items-center gap-3 p-3 rounded-xl border transition-all duration-300 ease-out origin-center ";
                        let bgClass = "";

                        if (isActive) {
                            wrapperClass += "scale-105 z-10 shadow-xl ring-1 ring-blue-500/50 ";
                            bgClass = isDone ? "bg-emerald-900/30 border-emerald-500" : "bg-slate-800 border-blue-500/50";
                        } else {
                            wrapperClass += "scale-95 opacity-60 blur-[0.5px] grayscale-[0.3] hover:opacity-100 hover:scale-100 hover:blur-0 hover:grayscale-0 ";
                            bgClass = isDone ? "bg-emerald-900/20 border-emerald-500/30" : "bg-slate-800/50 border-slate-700";
                        }
                        
                        row.className = wrapperClass + bgClass;
                    }
                };

                window.updateSet = (exIndex, setIndex, field, value) => {
                    sessionData.exercises[exIndex].sets[setIndex][field] = value;
                };

                window.toggleExerciseSkip = (exIndex) => {
                    const exData = sessionData.exercises[exIndex];
                    exData.skipped = !exData.skipped;
                    const isSkipped = exData.skipped;

                    // Manipulação direta do DOM para evitar reload
                    const block = document.getElementById(`exercise-block-${exIndex}`);
                    const setsContainer = document.getElementById(`sets-container-${exIndex}`);
                    const titleContainer = block.querySelector('h3');
                    const skipBtn = block.querySelector('button[onclick^="toggleExerciseSkip"]');
                    const addSetBtn = block.querySelector('button[onclick^="addSet"]');

                    // 1. Estilo do Bloco
                    if (isSkipped) {
                        block.classList.add('opacity-50', 'grayscale');
                    } else {
                        block.classList.remove('opacity-50', 'grayscale');
                    }

                    // 2. Botão Pular
                    skipBtn.className = `text-xs font-bold px-3 py-1.5 rounded-lg border transition ${isSkipped ? 'bg-slate-700 text-white border-slate-500' : 'bg-slate-800 text-slate-400 border-slate-700 hover:text-white hover:border-slate-500'}`;
                    skipBtn.innerHTML = `<i class="fa-solid ${isSkipped ? 'fa-rotate-left' : 'fa-forward'} mr-1"></i> ${isSkipped ? 'Desfazer' : 'Pular'}`;

                    // 3. Badge "Pulado"
                    const badge = titleContainer.querySelector('.skipped-badge');
                    if (isSkipped && !badge) {
                        titleContainer.insertAdjacentHTML('beforeend', ' <span class="skipped-badge text-xs bg-slate-700 text-slate-300 px-2 py-0.5 rounded uppercase fade-in">Pulado</span>');
                    } else if (!isSkipped && badge) {
                        badge.remove();
                    }

                    // 4. Container de Sets (Desabilitar interação)
                    if (isSkipped) {
                        setsContainer.classList.add('pointer-events-none');
                    } else {
                        setsContainer.classList.remove('pointer-events-none');
                    }

                    // 5. Botão Adicionar Série
                    addSetBtn.disabled = isSkipped;
                    if(isSkipped) {
                        addSetBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    } else {
                        addSetBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    }
                };

                window.toggleSetDone = (event, exIndex, setIndex) => {
                    event.stopPropagation(); // Evita acionar o setActiveSet do container
                    const exData = sessionData.exercises[exIndex];
                    const set = exData.sets[setIndex];
                    
                    // Validação: Não permitir check se reps for vazio/zero
                    if (!set.done && (!set.reps || set.reps <= 0)) {
                        alert("Por favor, preencha as repetições antes de marcar como feito.");
                        return;
                    }

                    set.done = !set.done;
                    
                    // Se marcou como feito e não é o último, avança foco para o próximo
                    if (set.done && setIndex < exData.sets.length - 1) {
                        setActiveSet(exIndex, setIndex + 1);
                    } else {
                        // Apenas atualiza visual do atual
                        setActiveSet(exIndex, setIndex); // Força refresh de estilos (verde/azul)
                    }

                    // Atualiza botão especificamente (ícone/cor)
                    const btn = document.getElementById(`btn-check-${exIndex}-${setIndex}`);
                    const indexLabel = document.querySelector(`#set-row-${exIndex}-${setIndex} .font-mono.font-bold`);
                    const inputs = document.querySelectorAll(`#set-row-${exIndex}-${setIndex} input`);

                    if (set.done) {
                        btn.className = 'w-12 h-12 rounded-full flex items-center justify-center transition-all duration-200 shadow-md active:scale-90 shrink-0 bg-emerald-500 text-white shadow-emerald-900/50';
                        if(indexLabel) indexLabel.classList.replace('text-slate-300', 'text-emerald-400');
                        inputs.forEach(input => {
                            input.classList.remove('border-slate-600', 'text-white');
                            input.classList.add('border-emerald-500/30', 'text-emerald-100');
                        });
                    } else {
                        btn.className = 'w-12 h-12 rounded-full flex items-center justify-center transition-all duration-200 shadow-md active:scale-90 shrink-0 bg-slate-700 text-slate-400 hover:bg-slate-600';
                        if(indexLabel) indexLabel.classList.replace('text-emerald-400', 'text-slate-300');
                        inputs.forEach(input => {
                            input.classList.remove('border-emerald-500/30', 'text-emerald-100');
                            input.classList.add('border-slate-600', 'text-white');
                        });
                    }
                };

                window.finishSession = () => {
                    // Validação de "Tudo Feito ou Pulado"
                    const incompleteExercises = sessionData.exercises.filter(ex => {
                        // Se pulado, conta como completo
                        if (ex.skipped) return false;
                        
                        // Se não pulado, precisa ter pelo menos 1 set feito?
                        // O usuário pediu "tudo marcado como feito ou não feito".
                        // Vamos considerar que se não está pulado, precisa ter pelo menos 1 série feita.
                        const hasDoneSets = ex.sets.some(s => s.done);
                        return !hasDoneSets;
                    });

                    if (incompleteExercises.length > 0) {
                        const names = incompleteExercises.map(ex => {
                            const def = exerciseDB.find(d => d.id === ex.id);
                            return def ? def.name : 'Exercício';
                        }).join(', ');
                        
                        alert(`Você tem exercícios pendentes: \n${names}\n\nPor favor, marque pelo menos uma série como feita ou pule o exercício.`);
                        return;
                    }

                    if(!confirm('Finalizar e salvar treino?')) return;
                    clearInterval(timerInterval);
                    
                    // Salvar apenas exercícios não pulados e séries feitas
                    const cleanDetails = sessionData.exercises
                        .filter(ex => !ex.skipped) // Ignora exercícios pulados no log final
                        .map(ex => ({
                            exerciseId: ex.id,
                            sets: ex.sets.filter(s => s.done)
                        }))
                        .filter(ex => ex.sets.length > 0);

                    const log = {
                        id: Date.now().toString(),
                        workoutId: plan.id,
                        planName: plan.name,
                        date: new Date().toISOString(),
                        duration: Math.floor((Date.now() - sessionData.startTime) / 1000),
                        details: cleanDetails
                    };

                    store.saveLog(log);
                    router.navigate('history');
                };

                window.cancelSession = () => {
                    if(confirm('Cancelar treino atual? O progresso será perdido.')) {
                        clearInterval(timerInterval);
                        router.navigate('home');
                    }
                };

                renderInitialSession();
            },

            // --- VIEW: HISTÓRICO ---
            renderHistory(container) {
                if (store.data.logs.length === 0) {
                    container.innerHTML = `
                        <div class="flex flex-col items-center justify-center h-full text-slate-500 fade-in">
                            <i class="fa-solid fa-clock-rotate-left text-6xl mb-4"></i>
                            <p>Sem histórico ainda.</p>
                        </div>`;
                    return;
                }

                let html = `<div class="space-y-4 fade-in">`;
                
                store.data.logs.forEach(log => {
                    const date = new Date(log.date);
                    const dateStr = date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: '2-digit' });
                    const timeStr = date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                    const durationMin = Math.floor(log.duration / 60);

                    const totalVolume = log.details.reduce((acc, ex) => {
                        return acc + ex.sets.reduce((sAcc, s) => sAcc + (s.weight * s.reps), 0);
                    }, 0);

                    html += `
                        <div class="bg-slate-800 rounded-lg p-4 border border-slate-700 shadow-sm">
                            <div class="flex justify-between items-start border-b border-slate-700 pb-2 mb-2">
                                <div>
                                    <h3 class="font-bold text-white">${log.planName}</h3>
                                    <p class="text-xs text-slate-400">${dateStr} às ${timeStr}</p>
                                </div>
                                <div class="text-right">
                                    <span class="block text-blue-400 font-bold text-sm"><i class="fa-solid fa-stopwatch mr-1"></i>${durationMin} min</span>
                                    <span class="text-xs text-slate-500">Vol: ${totalVolume}kg</span>
                                </div>
                            </div>
                            <div class="space-y-1">
                                ${log.details.map(d => {
                                    const exName = exerciseDB.find(db => db.id === d.exerciseId)?.name || 'Exer';
                                    const bestSet = d.sets.reduce((prev, current) => (prev.weight > current.weight) ? prev : current, {weight:0});
                                    return `
                                        <div class="flex justify-between text-sm text-slate-300">
                                            <span>${d.sets.length}x ${exName}</span>
                                            <span class="text-slate-500">Max: ${bestSet.weight}kg</span>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                });
                html += `</div>`;
                container.innerHTML = html;
            },

            // --- VIEW: EXERCÍCIOS (Consulta) ---
            renderExercises(container) {
                container.innerHTML = `
                    <div class="fade-in space-y-4">
                        <input type="text" id="ex-search-input" aria-label="Pesquisar exercícios" placeholder="Buscar exercício..." class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-white focus:border-blue-500 outline-none transition">
                        <div id="ex-list-full" class="space-y-2"></div>
                    </div>
                `;

                const renderFullList = (filter = '') => {
                    const el = document.getElementById('ex-list-full');
                    el.innerHTML = '';
                    
                    // Agrupar por Categoria
                    const groups = {};
                    exerciseDB
                        .filter(e => e.name.toLowerCase().includes(filter.toLowerCase()) || e.category.toLowerCase().includes(filter.toLowerCase()))
                        .forEach(ex => {
                            if(!groups[ex.category]) groups[ex.category] = [];
                            groups[ex.category].push(ex);
                        });

                    Object.keys(groups).forEach(cat => {
                        const catDiv = document.createElement('div');
                        catDiv.className = 'mb-4';
                        catDiv.innerHTML = `<h3 class="text-blue-400 font-bold text-sm uppercase tracking-wider mb-2 border-b border-slate-800 pb-1">${cat}</h3>`;
                        
                        groups[cat].forEach(ex => {
                            const item = document.createElement('div');
                            item.className = 'bg-slate-800 p-3 rounded mb-2 border border-slate-700 flex justify-between';
                            item.innerHTML = `<span class="text-slate-200">${ex.name}</span>`;
                            catDiv.appendChild(item);
                        });
                        el.appendChild(catDiv);
                    });
                };

                document.getElementById('ex-search-input').addEventListener('input', (e) => renderFullList(e.target.value));
                renderFullList();
            },

            // --- VIEW: CONFIGURAÇÕES / DADOS ---
            renderSettings(container) {
                container.innerHTML = `
                    <div class="fade-in space-y-6">
                        <div class="bg-slate-800 p-4 rounded-xl border border-slate-700">
                            <h3 class="text-lg font-bold text-white mb-2">Gerenciar Dados</h3>
                            <p class="text-sm text-slate-400 mb-4">Exporte seus treinos para salvar um backup ou importe em outro dispositivo.</p>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <button onclick="store.exportData()" aria-label="Exportar dados para arquivo JSON" class="bg-blue-600 hover:bg-blue-500 text-white py-2 rounded flex flex-col items-center justify-center gap-2 transition active:scale-95">
                                    <i class="fa-solid fa-download text-xl"></i>
                                    <span>Exportar</span>
                                </button>
                                
                                <label aria-label="Importar dados de arquivo JSON" class="bg-slate-700 hover:bg-slate-600 text-white py-2 rounded flex flex-col items-center justify-center gap-2 cursor-pointer transition active:scale-95">
                                    <i class="fa-solid fa-upload text-xl"></i>
                                    <span>Importar</span>
                                    <input type="file" id="import-file" class="hidden" accept=".json" onchange="store.importData(this.files[0])">
                                </label>
                            </div>
                        </div>

                        <div class="bg-slate-800 p-4 rounded-xl border border-slate-700">
                            <h3 class="text-lg font-bold text-white mb-2">Sobre</h3>
                            <p class="text-sm text-slate-400">IronTrack v1.0</p>
                            <p class="text-xs text-slate-500 mt-2">Armazenamento local em uso: ${(JSON.stringify(store.data).length / 1024).toFixed(2)} KB</p>
                            
                            <button onclick="if(confirm('Tem certeza? Isso apagará TUDO.')) { localStorage.removeItem('ironTrackData'); location.reload(); }" class="mt-4 text-red-500 text-xs hover:text-red-400 underline">
                                Resetar todos os dados
                            </button>
                        </div>
                    </div>
                `;
            }
        };

        // Inicialização
        document.addEventListener('DOMContentLoaded', () => {
            store.init();
            router.navigate('home');
        });

    </script>
</body>
</html>
